<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CV Analyzer</title>
    <style>
        :root {
            --primary: #2563eb;
            --error: #dc2626;
            --success: #16a34a;
            --bg: #f9fafb;
            --border: #d1d5db;
        }
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            margin: 20px; 
            max-width: 1200px; 
            margin-left: auto; 
            margin-right: auto;
            background: var(--bg);
        }
        .upload-section, .template-section { 
            margin-bottom: 30px; 
            padding: 20px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: white;
        }
        .form-group { 
            margin-bottom: 10px; 
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        label { 
            display: block;
            min-width: 200px; 
            font-weight: 600; 
            margin-bottom: 5px;
            flex: 0 0 200px;
        }
        input, textarea, select { 
            flex: 1 1 60%; 
            padding: 8px; 
            border: 1px solid var(--border);
            border-radius: 4px;
            min-width: 250px;
        }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            cursor: pointer; 
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
        }
        .btn-danger { background: var(--error); }
        #statusMessage { 
            margin-top: 15px; 
            padding: 12px; 
            border-radius: 4px; 
            display: none;
        }
        .error { background: #fee2e2; color: var(--error); border: 1px solid #fecaca; }
        .success { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; }
        .action-buttons { margin-top: 20px; }
        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 8px; }
        h3 { color: #374151; }
        .dynamic-item { 
            border-left: 3px solid var(--primary); 
            padding-left: 10px; 
            margin-bottom: 10px; 
            position: relative;
        }
        .delete-btn { 
            position: absolute; 
            top: 0; 
            right: 0; 
            padding: 4px 8px; 
            font-size: 12px; 
        }
        @media (max-width: 768px) {
            label { flex: 0 0 100%; }
            input, textarea, select { flex: 0 0 100%; }
        }
    </style>
</head>
<body>

    <h1>AI CV Analyzer</h1>
    <div id="statusMessage" role="alert"></div>

    <div id="uploadSection" class="upload-section">
        <h2>Upload Your CV</h2>
        <p style="color: #6b7280; font-size: 14px;">
            <strong>Privacy Notice:</strong> Your CV data is processed temporarily and stored only in this browser. 
            Always review AI-generated content for accuracy. Max file size: 2MB.
        </p>
        <input type="file" id="cvFileInput" accept=".pdf" aria-label="CV PDF file input" />
        <button id="processBtn" onclick="handleCVProcess()" disabled>Analyze CV with AI</button>
    </div>

    <div id="cvTemplateSection" class="template-section" style="display: none;">
        <h2>CV Template (Editable)</h2>
        <form id="cvTemplateForm"></form>
        <div class="action-buttons">
            <button type="button" onclick="saveFormData('cv')">Save CV Data</button>
            <button type="button" class="btn-danger" onclick="resetForm('cv')">Clear CV</button>
        </div>
    </div>

    <div id="jobTemplateSection" class="template-section" style="display: none;">
        <h2>AI-Generated Job Questionnaire (Editable)</h2>
        <form id="jobTemplateForm"></form>
        <div class="action-buttons">
            <button type="button" onclick="saveFormData('job')">Save Job Data</button>
            <button type="button" class="btn-danger" onclick="resetForm('job')">Clear Job</button>
        </div>
    </div>

    <script>
        // --- IIFE to prevent global scope pollution ---
        (function() {
            'use strict';

            // --- Configuration ---
            const CONFIG = {
                BACKEND_API_ENDPOINT: '/api/processCV', // Use relative path for same-origin request
                MAX_FILE_SIZE_MB: 2, // 2MB limit as per requirements
                SUPPORTED_MIME_TYPES: ['application/pdf'],
                STORAGE_VERSION: 'v1.0',
                STORAGE_KEYS: { cv: 'cvData', job: 'jobData' }
            };

            // --- Sanitization & Validation Utilities ---
            const SecurityUtils = {
                sanitizeForDOM: (str) => {
                    if (typeof str !== 'string') return '';
                    const div = document.createElement('div');
                    div.textContent = str; // This escapes HTML entities
                    return div.innerHTML;
                },
                sanitizeErrorMessage: (msg) => {
                    if (typeof msg !== 'string') return 'An unknown error occurred';
                    // Remove potentially sensitive backend details
                    return msg.replace(/\(.*?\)|\[.*?\]/g, '').substring(0, 200);
                },
                validateFile: (file) => {
                    if (!file) throw new Error('No file selected');
                    if (!CONFIG.SUPPORTED_MIME_TYPES.includes(file.type)) {
                        throw new Error(`Invalid file type. Only PDFs are supported.`);
                    }
                    const maxSize = CONFIG.MAX_FILE_SIZE_MB * 1024 * 1024;
                    if (file.size > maxSize) {
                        throw new Error(`File too large. Maximum size is ${CONFIG.MAX_FILE_SIZE_MB}MB.`);
                    }
                }
            };

            // --- Data Persistence Utilities ---
            const StorageUtils = {
                save: (key, data) => {
                    try {
                        const payload = {
                            version: CONFIG.STORAGE_VERSION,
                            timestamp: new Date().toISOString(),
                             data
                        };
                        // Basic obfuscation (not encryption)
                        const obfuscated = btoa(JSON.stringify(payload));
                        localStorage.setItem(CONFIG.STORAGE_KEYS[key], obfuscated);
                        return true;
                    } catch (e) {
                        console.error('Storage save failed:', e);
                        return false;
                    }
                },
                load: (key) => {
                    try {
                        const obfuscated = localStorage.getItem(CONFIG.STORAGE_KEYS[key]);
                        if (!obfuscated) return null;
                        const payload = JSON.parse(atob(obfuscated));
                        if (payload.version !== CONFIG.STORAGE_VERSION) {
                            console.warn('Data version mismatch. Ignoring old data.');
                            return null;
                        }
                        return payload.data || null;
                    } catch (e) {
                        console.error('Storage load failed:', e);
                        return null;
                    }
                },
                clear: (key) => {
                    localStorage.removeItem(CONFIG.STORAGE_KEYS[key]);
                }
            };

            // --- DOM & Form Utilities ---
            const FormUtils = {
                clearDynamicContainer: (containerId) => {
                    document.getElementById(containerId).innerHTML = '';
                },
                createDeleteButton: (onclickHandler, type, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = 'Delete';
                    btn.className = 'delete-btn btn-danger';
                    btn.onclick = onclickHandler;
                    btn.setAttribute('aria-label', `Delete ${type} ${index + 1}`); // Accessibility
                    return btn;
                },
                disableButton: (btnId, disabled) => {
                    document.getElementById(btnId).disabled = disabled;
                }
            };

            // --- Dynamic Field Management ---
            const DynamicFields = {
                templates: {
                    certification: (index) => `
                        <div class="dynamic-item" data-type="certification">
                            <input type="text" name="certifications.${index}.name" placeholder="Certification Name" required>
                            <input type="text" name="certifications.${index}.issuingOrganization" placeholder="Issuing Organization">
                            <input type="date" name="certifications.${index}.date" placeholder="Date (YYYY-MM-DD)">
                        </div>`,
                    language: (index) => `
                        <div class="dynamic-item" data-type="language">
                            <input type="text" name="languages.${index}.name" placeholder="Language Name" required>
                            <input type="text" name="languages.${index}.proficiency" placeholder="Proficiency (e.g., Native, Fluent)">
                        </div>`,
                    experience: (index) => `
                        <div class="dynamic-item" data-type="experience">
                            <h4>Experience ${index + 1}</h4>
                            <input type="text" name="experience.${index}.jobTitle" placeholder="Job Title" required>
                            <input type="text" name="experience.${index}.companyName" placeholder="Company Name" required>
                            <input type="text" name="experience.${index}.employmentDates" placeholder="e.g., Jan 2020 - Dec 2022">
                            <input type="text" name="experience.${index}.location" placeholder="Location">
                            <textarea name="experience.${index}.keyResponsibilities" rows="2" placeholder="Key Responsibilities"></textarea>
                            <textarea name="experience.${index}.keyAchievements" rows="2" placeholder="Key Achievements"></textarea>
                        </div>`,
                    education: (index) => `
                        <div class="dynamic-item" data-type="education">
                            <h4>Education ${index + 1}</h4>
                            <input type="text" name="education.${index}.degree" placeholder="Degree/Qualification" required>
                            <input type="text" name="education.${index}.institutionName" placeholder="Institution Name" required>
                            <input type="text" name="education.${index}.completionDate" placeholder="e.g., 2022">
                            <input type="text" name="education.${index}.location" placeholder="Location">
                        </div>`
                },
                add: (containerId, type) => {
                    const container = document.getElementById(containerId);
                    const existingItems = container.querySelectorAll(`[data-type="${type}"]`);
                    const index = existingItems.length;
                    container.insertAdjacentHTML('beforeend', DynamicFields.templates[type](index));
                    const newItem = container.lastElementChild; // Get the newly added item
                    const deleteBtn = FormUtils.createDeleteButton(() => newItem.remove(), type, index);
                    newItem.appendChild(deleteBtn);
                }
            };

            // --- Form Population & Serialization ---
            const FormSerializer = {
                populate: (formId, data) => {
                    const form = document.getElementById(formId);
                    if (!data || !form) return;

                    // Clear existing dynamic fields
                    ['certificationsContainer', 'languagesContainer', 'experienceContainer', 'educationContainer'].forEach(id => {
                        FormUtils.clearDynamicContainer(id);
                    });

                    // Pre-populate dynamic fields based on array lengths from data
                    const arrayLengths = {
                        certifications: data.certifications?.length || 0,
                        languages: data.languages?.length || 0,
                        experience: data.experience?.length || 0,
                        education: data.education?.length || 0
                    };

                    for (let i = 0; i < arrayLengths.certifications; i++) DynamicFields.add('certificationsContainer', 'certification');
                    for (let i = 0; i < arrayLengths.languages; i++) DynamicFields.add('languagesContainer', 'language');
                    for (let i = 0; i < arrayLengths.experience; i++) DynamicFields.add('experienceContainer', 'experience');
                    for (let i = 0; i < arrayLengths.education; i++) DynamicFields.add('educationContainer', 'education');

                    // Set values for all fields after DOM is populated using setTimeout to ensure DOM is ready
                    setTimeout(() => {
                        const flattened = FormSerializer.flattenObject(data);
                        Object.entries(flattened).forEach(([key, value]) => {
                            const element = form.querySelector(`[name="${key}"]`);
                            if (element && value !== undefined && value !== null) {
                                element.value = SecurityUtils.sanitizeForDOM(value);
                            }
                        });
                    }, 0);
                },
                flattenObject: (obj, prefix = '') => {
                    const flattened = {};
                    for (const [key, value] of Object.entries(obj)) {
                        const newKey = prefix ? `${prefix}.${key}` : key;
                        if (Array.isArray(value)) {
                            value.forEach((item, index) => {
                                Object.assign(flattened, FormSerializer.flattenObject(item, `${newKey}.${index}`));
                            });
                        } else if (typeof value === 'object' && value !== null) {
                            Object.assign(flattened, FormSerializer.flattenObject(value, newKey));
                        } else {
                            flattened[newKey] = value;
                        }
                    }
                    return flattened;
                },
                serialize: (form) => {
                    const formData = new FormData(form);
                    const result = {};

                    for (const [key, value] of formData.entries()) {
                        FormSerializer.setNestedValue(result, key, value);
                    }
                    return result;
                },
                setNestedValue: (obj, path, value) => {
                    const keys = path.split('.');
                    let current = obj;

                    for (let i = 0; i < keys.length - 1; i++) {
                        const key = keys[i];
                        const nextKey = keys[i + 1];
                        const isArrayIndex = /^\d+$/.test(nextKey);

                        if (!(key in current)) {
                            current[key] = isArrayIndex ? [] : {};
                        }
                        current = current[key];
                    }

                    const finalKey = keys[keys.length - 1];
                    // Ensure array index assignment works correctly
                    if (Array.isArray(current)) {
                        const index = parseInt(finalKey, 10);
                        if (!isNaN(index)) {
                            current[index] = value;
                        } else {
                            // Handle non-numeric keys within an array item context (shouldn't happen with our naming)
                            current.push({ [finalKey]: value });
                        }
                    } else {
                        current[finalKey] = value;
                    }
                }
            };

            // --- UI State Management ---
            const UI = {
                showMessage: (message, isError = false) => {
                    const statusDiv = document.getElementById('statusMessage');
                    statusDiv.textContent = SecurityUtils.sanitizeForDOM(message);
                    statusDiv.className = isError ? 'error' : 'success';
                    statusDiv.style.display = 'block';
                    statusDiv.setAttribute('role', 'alert');

                    if (!isError) {
                        setTimeout(() => UI.hideMessage(), 5000);
                    }
                },
                hideMessage: () => {
                    document.getElementById('statusMessage').style.display = 'none';
                },
                setProcessingState: (isProcessing) => {
                    FormUtils.disableButton('processBtn', isProcessing);
                    const btn = document.getElementById('processBtn');
                    btn.textContent = isProcessing ? 'Processing...' : 'Analyze CV with AI';
                }
            };

            // --- Main Processing Logic ---
            async function handleCVProcess() {
                const fileInput = document.getElementById('cvFileInput');
                const file = fileInput.files[0];

                try {
                    SecurityUtils.validateFile(file);

                    const hasExistingData = StorageUtils.load('cv') || StorageUtils.load('job');
                    if (hasExistingData && !confirm('This will replace existing data. Continue?')) {
                        return;
                    }

                    UI.hideMessage();
                    UI.setProcessingState(true);
                    UI.showMessage('Processing CV... Please wait.');

                    const arrayBuffer = await file.arrayBuffer();
                    // Convert ArrayBuffer to base64 string for sending via fetch
                    const base64String = arrayBufferToBase64(arrayBuffer);

                    const response = await fetch(CONFIG.BACKEND_API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest' // Help backend identify AJAX
                        },
                        body: JSON.stringify({ pdfBase64: base64String })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Backend error: ${response.status}`);
                    }

                    const result = await response.json();

                    if (!result || typeof result !== 'object') {
                        throw new Error('Invalid response format from server');
                    }

                    FormSerializer.populate('cvTemplateForm', result.cvData || {});
                    FormSerializer.populate('jobTemplateForm', result.jobData || {});

                    document.getElementById('cvTemplateSection').style.display = 'block';
                    document.getElementById('jobTemplateSection').style.display = 'block';
                    document.getElementById('uploadSection').style.display = 'none';

                    UI.showMessage('CV analyzed successfully! Please review and edit the templates.');
                } catch (error) {
                    console.error('Processing error:', error);
                    UI.showMessage(`Error: ${SecurityUtils.sanitizeErrorMessage(error.message)}`, true);
                } finally {
                    UI.setProcessingState(false);
                }
            }

            function arrayBufferToBase64(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }

            // --- Save & Reset Functions ---
            function saveFormData(type) {
                const formId = type === 'cv' ? 'cvTemplateForm' : 'jobTemplateForm';
                const data = FormSerializer.serialize(document.getElementById(formId));

                if (StorageUtils.save(type, data)) {
                    UI.showMessage(`${type === 'cv' ? 'CV' : 'Job'} data saved securely to browser.`);
                } else {
                    UI.showMessage('Failed to save data. Storage may be full.', true);
                }
            }

            function resetForm(type) {
                if (!confirm(`Are you sure you want to clear all ${type === 'cv' ? 'CV' : 'Job'} data?`)) {
                    return;
                }

                StorageUtils.clear(type);
                const formId = type === 'cv' ? 'cvTemplateForm' : 'jobTemplateForm';
                document.getElementById(formId).reset();

                ['certificationsContainer', 'languagesContainer', 'experienceContainer', 'educationContainer'].forEach(id => {
                    FormUtils.clearDynamicContainer(id);
                });

                UI.showMessage(`${type === 'cv' ? 'CV' : 'Job'} data cleared.`);

                const cvCleared = !StorageUtils.load('cv');
                const jobCleared = !StorageUtils.load('job');
                if (cvCleared && jobCleared) {
                    document.getElementById('cvTemplateSection').style.display = 'none';
                    document.getElementById('jobTemplateSection').style.display = 'none';
                    document.getElementById('uploadSection').style.display = 'block';
                }
            }

            // --- File Input Change Handler ---
            document.getElementById('cvFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const btn = document.getElementById('processBtn');
                btn.disabled = !file; // Enable button when file is selected
            });

            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', function() {
                const savedCv = StorageUtils.load('cv');
                const savedJob = StorageUtils.load('job');

                if (savedCv) {
                    FormSerializer.populate('cvTemplateForm', savedCv);
                    document.getElementById('cvTemplateSection').style.display = 'block';
                }
                if (savedJob) {
                    FormSerializer.populate('jobTemplateForm', savedJob);
                    document.getElementById('jobTemplateSection').style.display = 'block';
                }
                if (savedCv || savedJob) {
                    document.getElementById('uploadSection').style.display = 'none';
                    UI.showMessage('Loaded previously saved data from this browser.');
                }

                // Add keyboard accessibility to file input
                document.getElementById('cvFileInput').addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault(); // Prevent scrolling
                        this.click(); // Trigger file selection
                    }
                });
            });

            // --- Expose functions to global scope for button onclick ---
            window.handleCVProcess = handleCVProcess;
            window.saveFormData = saveFormData;
            window.resetForm = resetForm;
            window.addCertification = () => DynamicFields.add('certificationsContainer', 'certification');
            window.addLanguage = () => DynamicFields.add('languagesContainer', 'language');
            window.addExperience = () => DynamicFields.add('experienceContainer', 'experience');
            window.addEducation = () => DynamicFields.add('educationContainer', 'education');
        })();
    </script>

</body>
</html>