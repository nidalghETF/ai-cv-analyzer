<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CV Analyzer</title>
    <style>
        :root {
            --primary: #2563eb;
            --error: #dc2626;
            --success: #16a34a;
            --bg: #f9fafb;
            --border: #d1d5db;
        }
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            margin: 20px; 
            max-width: 1200px; 
            margin-left: auto; 
            margin-right: auto;
            background: var(--bg);
        }
        .upload-section, .template-section { 
            margin-bottom: 30px; 
            padding: 20px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: white;
        }
        .form-group { 
            margin-bottom: 10px; 
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        label { 
            display: block;
            min-width: 200px; 
            font-weight: 600; 
            margin-bottom: 5px;
            flex: 0 0 200px;
        }
        input, textarea, select { 
            flex: 1 1 60%; 
            padding: 8px; 
            border: 1px solid var(--border);
            border-radius: 4px;
            min-width: 250px;
        }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            cursor: pointer; 
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
        }
        .btn-danger { background: var(--error); }
        .btn-secondary { background: #6b7280; }
        #statusMessage { 
            margin-top: 15px; 
            padding: 12px; 
            border-radius: 4px; 
            display: none;
        }
        .error { background: #fee2e2; color: var(--error); border: 1px solid #fecaca; }
        .success { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; }
        .action-buttons { margin-top: 20px; }
        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 8px; }
        h3 { color: #374151; margin-top: 20px; }
        .dynamic-item { 
            border-left: 3px solid var(--primary); 
            padding: 15px;
            margin-bottom: 15px; 
            position: relative;
            background: #f8fafc;
            border-radius: 4px;
        }
        .delete-btn { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            padding: 4px 8px; 
            font-size: 12px; 
        }
        .dynamic-container { margin-bottom: 15px; }
        .add-btn { margin: 10px 0; }
        @media (max-width: 768px) {
            label { flex: 0 0 100%; }
            input, textarea, select { flex: 0 0 100%; }
            .dynamic-item { padding: 10px; }
        }
    </style>
</head>
<body>

    <h1>AI CV Analyzer</h1>
    <div id="statusMessage" role="alert"></div>

    <div id="uploadSection" class="upload-section">
        <h2>Upload Your CV</h2>
        <p style="color: #6b7280; font-size: 14px;">
            <strong>Privacy Notice:</strong> Your CV data is processed temporarily and stored only in this browser. 
            Always review AI-generated content for accuracy. Max file size: 2MB.
        </p>
        <input type="file" id="cvFileInput" accept=".pdf" aria-label="CV PDF file input" />
        <button id="processBtn" onclick="handleCVProcess()" disabled>Analyze CV with AI</button>
    </div>

    <div id="cvTemplateSection" class="template-section" style="display: none;">
        <h2>CV Template (Editable)</h2>
        <form id="cvTemplateForm">
            <h3>Personal Information</h3>
            <div class="form-group">
                <label for="personalInfo.fullName">Full Name:</label>
                <input type="text" name="personalInfo.fullName" id="personalInfo.fullName">
            </div>
            <div class="form-group">
                <label for="personalInfo.professionalTitle">Professional Title:</label>
                <input type="text" name="personalInfo.professionalTitle" id="personalInfo.professionalTitle">
            </div>
            <div class="form-group">
                <label for="personalInfo.phone">Phone:</label>
                <input type="text" name="personalInfo.phone" id="personalInfo.phone">
            </div>
            <div class="form-group">
                <label for="personalInfo.email">Email:</label>
                <input type="email" name="personalInfo.email" id="personalInfo.email">
            </div>
            <div class="form-group">
                <label for="personalInfo.location">Location:</label>
                <input type="text" name="personalInfo.location" id="personalInfo.location">
            </div>
            <div class="form-group">
                <label for="personalInfo.linkedIn">LinkedIn:</label>
                <input type="text" name="personalInfo.linkedIn" id="personalInfo.linkedIn">
            </div>
            <div class="form-group">
                <label for="personalInfo.portfolio">Portfolio:</label>
                <input type="text" name="personalInfo.portfolio" id="personalInfo.portfolio">
            </div>

            <h3>Professional Summary</h3>
            <div class="form-group">
                <label for="professionalSummary">Summary:</label>
                <textarea name="professionalSummary" id="professionalSummary" rows="4"></textarea>
            </div>

            <h3>Core Competencies</h3>
            <div class="form-group">
                <label for="coreCompetencies.technicalSkills">Technical Skills:</label>
                <input type="text" name="coreCompetencies.technicalSkills" id="coreCompetencies.technicalSkills" placeholder="Comma-separated list">
            </div>
            <div class="form-group">
                <label for="coreCompetencies.softSkills">Soft Skills:</label>
                <input type="text" name="coreCompetencies.softSkills" id="coreCompetencies.softSkills" placeholder="Comma-separated list">
            </div>

            <h3>Certifications</h3>
            <div id="certificationsContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" onclick="addCertification()">+ Add Certification</button>

            <h3>Languages</h3>
            <div id="languagesContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" onclick="addLanguage()">+ Add Language</button>

            <h3>Professional Experience</h3>
            <div id="experienceContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" onclick="addExperience()">+ Add Experience</button>

            <h3>Education</h3>
            <div id="educationContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" onclick="addEducation()">+ Add Education</button>

            <h3>Projects</h3>
<div id="projectsContainer" class="dynamic-container"></div>
<button type="button" class="btn-secondary add-btn" onclick="addProject()">+ Add Project</button>

<h3>Additional Information</h3>
<div class="form-group">
    <label for="additionalInfo.publications">Publications:</label>
    <textarea name="additionalInfo.publications" id="additionalInfo.publications" rows="3"></textarea>
</div>
            <div class="form-group">
                <label for="additionalInfo.professionalMemberships">Professional Memberships:</label>
                <textarea name="additionalInfo.professionalMemberships" id="additionalInfo.professionalMemberships" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="additionalInfo.volunteerExperience">Volunteer Experience:</label>
                <textarea name="additionalInfo.volunteerExperience" id="additionalInfo.volunteerExperience" rows="3"></textarea>
            </div>
        </form>
        <div class="action-buttons">
            <button type="button" onclick="saveFormData('cv')">Save CV Data</button>
            <button type="button" class="btn-danger" onclick="resetForm('cv')">Clear CV</button>
            <button type="button" onclick="exportProject()">Export Project as JSON</button>
        </div>
    </div>

    <div id="jobTemplateSection" class="template-section" style="display: none;">
        <h2>AI-Generated Job Questionnaire (Editable)</h2>
        <form id="jobTemplateForm">
            <h3>Job Identification</h3>
            <div class="form-group">
                <label for="jobIdentification.jobTitle">Job Title:</label>
                <input type="text" name="jobIdentification.jobTitle" id="jobIdentification.jobTitle">
            </div>
            <div class="form-group">
                <label for="jobIdentification.referenceID">Reference ID:</label>
                <input type="text" name="jobIdentification.referenceID" id="jobIdentification.referenceID">
            </div>
            <div class="form-group">
                <label for="jobIdentification.department">Department:</label>
                <input type="text" name="jobIdentification.department" id="jobIdentification.department">
            </div>
            <div class="form-group">
                <label for="jobIdentification.positionType">Position Type:</label>
                <select name="jobIdentification.positionType" id="jobIdentification.positionType">
                    <option value="">Select Type</option>
                    <option value="Full-time">Full-time</option>
                    <option value="Part-time">Part-time</option>
                    <option value="Contract">Contract</option>
                    <option value="Remote">Remote</option>
                </select>
            </div>

            <h3>Company Information</h3>
            <div class="form-group">
                <label for="companyInformation.companyName">Company Name:</label>
                <input type="text" name="companyInformation.companyName" id="companyInformation.companyName">
            </div>
            <div class="form-group">
                <label for="companyInformation.companySize">Company Size:</label>
                <input type="text" name="companyInformation.companySize" id="companyInformation.companySize">
            </div>
            <div class="form-group">
                <label for="companyInformation.industrySector">Industry Sector:</label>
                <input type="text" name="companyInformation.industrySector" id="companyInformation.industrySector">
            </div>

            <h3>Position Details</h3>
            <div class="form-group">
                <label for="positionDetails.jobDescription">Job Description:</label>
                <textarea name="positionDetails.jobDescription" id="positionDetails.jobDescription" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="positionDetails.keyResponsibilities">Key Responsibilities:</label>
                <textarea name="positionDetails.keyResponsibilities" id="positionDetails.keyResponsibilities" rows="4"></textarea>
            </div>

            <h3>Candidate Requirements</h3>
            <div class="form-group">
                <label for="candidateRequirements.requiredEducationLevel">Required Education:</label>
                <input type="text" name="candidateRequirements.requiredEducationLevel" id="candidateRequirements.requiredEducationLevel">
            </div>
            <div class="form-group">
                <label for="candidateRequirements.requiredFieldOfStudy">Field of Study:</label>
                <input type="text" name="candidateRequirements.requiredFieldOfStudy" id="candidateRequirements.requiredFieldOfStudy">
            </div>
            <div class="form-group">
                <label for="candidateRequirements.requiredYearsOfExperience">Years of Experience:</label>
                <input type="number" name="candidateRequirements.requiredYearsOfExperience" id="candidateRequirements.requiredYearsOfExperience">
            </div>
            <div class="form-group">
                <label for="candidateRequirements.requiredSkills">Required Skills:</label>
                <textarea name="candidateRequirements.requiredSkills" id="candidateRequirements.requiredSkills" rows="3"></textarea>
            </div>

            <h3>Compensation & Benefits</h3>
            <div class="form-group">
                <label for="compensationBenefits.salaryRange">Salary Range:</label>
                <input type="text" name="compensationBenefits.salaryRange" id="compensationBenefits.salaryRange">
            </div>
            <div class="form-group">
                <label for="compensationBenefits.bonusStructure">Bonus Structure:</label>
                <input type="text" name="compensationBenefits.bonusStructure" id="compensationBenefits.bonusStructure">
            </div>
            <div class="form-group">
                <label for="compensationBenefits.healthInsurance">Health Insurance:</label>
                <input type="text" name="compensationBenefits.healthInsurance" id="compensationBenefits.healthInsurance">
            </div>
        </form>
        <div class="action-buttons">
            <button type="button" onclick="saveFormData('job')">Save Job Data</button>
            <button type="button" class="btn-danger" onclick="resetForm('job')">Clear Job</button>
            <button type="button" onclick="importProject()">Import Project from JSON</button>
        </div>
    </div>

    <input type="file" id="importFileInput" style="display: none;" accept=".json" />

    <script>
        // --- IIFE to prevent global scope pollution ---
        (function() {
            'use strict';

            // --- Configuration ---
            const CONFIG = {
                BACKEND_API_ENDPOINT: '/api/processCV',
                MAX_FILE_SIZE_MB: 2,
                SUPPORTED_MIME_TYPES: ['application/pdf'], // ✅ FIXED: Corrected spelling
                STORAGE_VERSION: 'v1.0',
                STORAGE_KEYS: { cv: 'cvData', job: 'jobData' }
            };

            // --- Sanitization & Validation Utilities ---
            const SecurityUtils = {
                sanitizeForDOM: (str) => {
                    if (typeof str !== 'string') return '';
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                },
                sanitizeErrorMessage: (msg) => {
                    if (typeof msg !== 'string') return 'An unknown error occurred';
                    return msg.replace(/\(.*?\)|\[.*?\]/g, '').substring(0, 200);
                },
                validateFile: (file) => {
                    if (!file) throw new Error('No file selected');
                    // ✅ FIXED: Corrected typo - SUPPORTED instead of SUPORTED
                    if (!CONFIG.SUPPORTED_MIME_TYPES.includes(file.type)) {
                        throw new Error(`Invalid file type. Only PDFs are supported.`);
                    }
                    const maxSize = CONFIG.MAX_FILE_SIZE_MB * 1024 * 1024;
                    if (file.size > maxSize) {
                        throw new Error(`File too large. Maximum size is ${CONFIG.MAX_FILE_SIZE_MB}MB.`);
                    }
                }
            };

            // --- Data Persistence Utilities ---
            const StorageUtils = {
                save: (key, data) => {
                    try {
                        const payload = {
                            version: CONFIG.STORAGE_VERSION,
                            timestamp: new Date().toISOString(),
                            data: data
                        };
                        const obfuscated = btoa(JSON.stringify(payload));
                        localStorage.setItem(CONFIG.STORAGE_KEYS[key], obfuscated);
                        return true;
                    } catch (e) {
                        console.error('Storage save failed:', e);
                        return false;
                    }
                },
                load: (key) => {
                    try {
                        const obfuscated = localStorage.getItem(CONFIG.STORAGE_KEYS[key]);
                        if (!obfuscated) return null;
                        const payload = JSON.parse(atob(obfuscated));
                        if (payload.version !== CONFIG.STORAGE_VERSION) {
                            console.warn('Data version mismatch. Ignoring old data.');
                            return null;
                        }
                        return payload.data || null;
                    } catch (e) {
                        console.error('Storage load failed:', e);
                        return null;
                    }
                },
                clear: (key) => {
                    localStorage.removeItem(CONFIG.STORAGE_KEYS[key]);
                }
            };

            // --- DOM & Form Utilities ---
            const FormUtils = {
                clearDynamicContainer: (containerId) => {
                    const container = document.getElementById(containerId);
                    if (!container) {
                        console.error(`Container not found: ${containerId}`);
                        return;
                    }
                    container.innerHTML = '';
                },
                createDeleteButton: (onclickHandler, type, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = 'Delete';
                    btn.className = 'delete-btn btn-danger';
                    btn.onclick = onclickHandler;
                    btn.setAttribute('aria-label', `Delete ${type} ${index + 1}`);
                    return btn;
                },
                disableButton: (btnId, disabled) => {
                    const btn = document.getElementById(btnId);
                    if (btn) btn.disabled = disabled;
                }
            };

            // --- Dynamic Field Management ---
               education: (index) => `
        <div class="dynamic-item" data-type="education">
          <h4>Education ${index + 1}</h4>
          <input type="text" name="education.${index}.degree" placeholder="Degree/Qualification" required>
          <input type="text" name="education.${index}.institutionName" placeholder="Institution Name" required>
          <input type="text" name="education.${index}.completionDate" placeholder="e.g., 2022">
          <input type="text" name="education.${index}.location" placeholder="Location">
        </div>`,
    // ▼▼▼ ADD THIS PROJECT TEMPLATE ▼▼▼
    project: (index) => `
        <div class="dynamic-item" data-type="project">
          <h4>Project ${index + 1}</h4>
          <input type="text" name="projects.${index}.title" placeholder="Project Title" required>
          <input type="text" name="projects.${index}.description" placeholder="Project Description">
          <input type="text" name="projects.${index}.technologies" placeholder="Technologies Used">
          <input type="text" name="projects.${index}.dates" placeholder="Project Dates">
          <input type="text" name="projects.${index}.url" placeholder="Project URL/Link">
        </div>`
    // ▲▲▲ END OF ADDED TEMPLATE ▲▲▲
  },
                    language: (index) => `
                        <div class="dynamic-item" data-type="language">
                            <input type="text" name="languages.${index}.name" placeholder="Language Name" required>
                            <input type="text" name="languages.${index}.proficiency" placeholder="Proficiency (e.g., Native, Fluent)">
                        </div>`,
                    experience: (index) => `
                        <div class="dynamic-item" data-type="experience">
                            <h4>Experience ${index + 1}</h4>
                            <input type="text" name="experience.${index}.jobTitle" placeholder="Job Title" required>
                            <input type="text" name="experience.${index}.companyName" placeholder="Company Name" required>
                            <input type="text" name="experience.${index}.employmentDates" placeholder="e.g., Jan 2020 - Dec 2022">
                            <input type="text" name="experience.${index}.location" placeholder="Location">
                            <textarea name="experience.${index}.keyResponsibilities" rows="2" placeholder="Key Responsibilities"></textarea>
                            <textarea name="experience.${index}.keyAchievements" rows="2" placeholder="Key Achievements"></textarea>
                        </div>`,
                    education: (index) => `
                        <div class="dynamic-item" data-type="education">
                            <h4>Education ${index + 1}</h4>
                            <input type="text" name="education.${index}.degree" placeholder="Degree/Qualification" required>
                            <input type="text" name="education.${index}.institutionName" placeholder="Institution Name" required>
                            <input type="text" name="education.${index}.completionDate" placeholder="e.g., 2022">
                            <input type="text" name="education.${index}.location" placeholder="Location">
                        </div>`
                },
                add: (containerId, type) => {
                    const container = document.getElementById(containerId);
                    if (!container) {
                        console.error(`Container not found: ${containerId}`);
                        return;
                    }
                    const existingItems = container.querySelectorAll(`[data-type="${type}"]`);
                    const index = existingItems.length;
                    container.insertAdjacentHTML('beforeend', DynamicFields.templates[type](index));
                    const newItem = container.lastElementChild;
                    const deleteBtn = FormUtils.createDeleteButton(() => newItem.remove(), type, index);
                    newItem.appendChild(deleteBtn);
                }
            };

            // --- Form Population & Serialization ---
const FormSerializer = {
  populate: (formId, data) => {
    const form = document.getElementById(formId);
    if (!data || !form) return;

    // Clear existing dynamic fields
    ['certificationsContainer', 'languagesContainer', 'experienceContainer', 'educationContainer', 'projectsContainer'].forEach(id => {
      FormUtils.clearDynamicContainer(id);
    });

    // PRE-CREATE 3 DEFAULT FIELDS + AI-DETECTED FIELDS
    const fieldCreation = {
      certifications: Math.max(data.certifications?.length || 0, 3),
      languages: Math.max(data.languages?.length || 0, 3),
      experience: Math.max(data.experience?.length || 0, 3),
      education: Math.max(data.education?.length || 0, 3),
      projects: Math.max(data.projects?.length || 0, 3)
    };

    // Create fields (minimum 3 of each type)
    for (let i = 0; i < fieldCreation.certifications; i++) DynamicFields.add('certificationsContainer', 'certification');
    for (let i = 0; i < fieldCreation.languages; i++) DynamicFields.add('languagesContainer', 'language');
    for (let i = 0; i < fieldCreation.experience; i++) DynamicFields.add('experienceContainer', 'experience');
    for (let i = 0; i < fieldCreation.education; i++) DynamicFields.add('educationContainer', 'education');
    for (let i = 0; i < fieldCreation.projects; i++) DynamicFields.add('projectsContainer', 'project');

    // Set values after DOM is populated
    setTimeout(() => {
      const flattened = FormSerializer.flattenObject(data);
      Object.entries(flattened).forEach(([key, value]) => {
        const element = form.querySelector(`[name="${key}"]`);
        if (element && value !== undefined && value !== null && value !== '') {
          element.value = SecurityUtils.sanitizeForDOM(value);
        }
      });
    }, 100);
  },

flattenObject: (obj, prefix = '') => {
  const flattened = {};
  for (const [key, value] of Object.entries(obj)) {
    const newKey = prefix ? `${prefix}.${key}` : key;
    if (Array.isArray(value)) {
      value.forEach((item, index) => {
        Object.assign(flattened, FormSerializer.flattenObject(item, `${newKey}.${index}`));
      });
    } else if (typeof value === 'object' && value !== null) {
      Object.assign(flattened, FormSerializer.flattenObject(value, newKey));
    } else {
      flattened[newKey] = value;
    }
  }
  return flattened;
},

serialize: (form) => {
  const formData = new FormData(form)
    const result = {};

    for (const [key, value] of formData.entries()) {
      FormSerializer.setNestedValue(result, key, value);
    }
    return result;
  },

  setNestedValue: (obj, path, value) => {
    const keys = path.split('.');
    let current = obj;

    for (let i = 0; i < keys.length - 1; i++) {
      const key = keys[i];
      const nextKey = keys[i + 1];
      const isArrayIndex = /^\d+$/.test(nextKey);

      if (!(key in current)) {
        current[key] = isArrayIndex ? [] : {};
      }
      current = current[key];
    }

    const finalKey = keys[keys.length - 1];
    if (Array.isArray(current)) {
      const index = parseInt(finalKey, 10);
      if (!isNaN(index)) {
        current[index] = value;
      } else {
        current.push({ [finalKey]: value });
      }
    } else {
      current[finalKey] = value;
    }
  }
};

            // --- UI State Management ---
            const UI = {
                showMessage: (message, isError = false) => {
                    const statusDiv = document.getElementById('statusMessage');
                    statusDiv.textContent = SecurityUtils.sanitizeForDOM(message);
                    statusDiv.className = isError ? 'error' : 'success';
                    statusDiv.style.display = 'block';
                    statusDiv.setAttribute('role', 'alert');

                    if (!isError) {
                        setTimeout(() => UI.hideMessage(), 5000);
                    }
                },
                hideMessage: () => {
                    const statusDiv = document.getElementById('statusMessage');
                    if (statusDiv) statusDiv.style.display = 'none';
                },
                setProcessingState: (isProcessing) => {
                    FormUtils.disableButton('processBtn', isProcessing);
                    const btn = document.getElementById('processBtn');
                    if (btn) {
                        btn.textContent = isProcessing ? 'Processing...' : 'Analyze CV with AI';
                    }
                }
            };

            // --- JSON Export/Import ---
            const ProjectManager = {
                exportProject: () => {
                    try {
                        const cvData = FormSerializer.serialize(document.getElementById('cvTemplateForm'));
                        const jobData = FormSerializer.serialize(document.getElementById('jobTemplateForm'));
                        
                        const projectData = {
                            cvData: cvData,
                            jobData: jobData,
                            metadata: {
                                exportDate: new Date().toISOString(),
                                version: CONFIG.STORAGE_VERSION,
                                projectName: 'CV_Analyzer_Project'
                            }
                        };

                        const dataStr = JSON.stringify(projectData, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `CV_Project_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        UI.showMessage('Project exported successfully!');
                    } catch (error) {
                        console.error('Export error:', error);
                        UI.showMessage('Failed to export project', true);
                    }
                },

                importProject: () => {
                    document.getElementById('importFileInput').click();
                },

                handleImportFile: (file) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const projectData = JSON.parse(e.target.result);
                            
                            // Validate structure
                            if (!projectData.cvData || !projectData.jobData) {
                                throw new Error('Invalid project file structure');
                            }

                            if (confirm('This will replace all current data. Continue?')) {
                                FormSerializer.populate('cvTemplateForm', projectData.cvData);
                                FormSerializer.populate('jobTemplateForm', projectData.jobData);
                                
                                document.getElementById('cvTemplateSection').style.display = 'block';
                                document.getElementById('jobTemplateSection').style.display = 'block';
                                document.getElementById('uploadSection').style.display = 'none';
                                
                                UI.showMessage('Project imported successfully!');
                            }
                        } catch (error) {
                            console.error('Import error:', error);
                            UI.showMessage('Invalid project file format', true);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            // --- Main Processing Logic ---
            async function handleCVProcess() {
                const fileInput = document.getElementById('cvFileInput');
                const file = fileInput.files[0];

                try {
                    SecurityUtils.validateFile(file);

                    const hasExistingData = StorageUtils.load('cv') || StorageUtils.load('job');
                    if (hasExistingData && !confirm('This will replace existing data. Continue?')) {
                        return;
                    }

                    UI.hideMessage();
                    UI.setProcessingState(true);
                    UI.showMessage('Processing CV... Please wait.');

                    const arrayBuffer = await file.arrayBuffer();
                    const base64String = arrayBufferToBase64(arrayBuffer);

                    const response = await fetch(CONFIG.BACKEND_API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ 
                            pdfBase64: base64String,
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Backend error: ${response.status}`);
                    }

                    const result = await response.json();

                    if (!result || typeof result !== 'object') {
                        throw new Error('Invalid response format from server');
                    }

                    FormSerializer.populate('cvTemplateForm', result.cvData || {});
                    FormSerializer.populate('jobTemplateForm', result.jobData || {});

                    document.getElementById('cvTemplateSection').style.display = 'block';
                    document.getElementById('jobTemplateSection').style.display = 'block';
                    document.getElementById('uploadSection').style.display = 'none';

                    UI.showMessage('CV analyzed successfully! Please review and edit the templates.');
                } catch (error) {
                    console.error('Processing error:', error);
                    UI.showMessage(`Error: ${SecurityUtils.sanitizeErrorMessage(error.message)}`, true);
                } finally {
                    UI.setProcessingState(false);
                }
            }

            function arrayBufferToBase64(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }

            // --- Save & Reset Functions ---
            function saveFormData(type) {
                const formId = type === 'cv' ? 'cvTemplateForm' : 'jobTemplateForm';
                const form = document.getElementById(formId);
                if (!form) return;

                const data = FormSerializer.serialize(form);

                if (StorageUtils.save(type, data)) {
                    UI.showMessage(`${type === 'cv' ? 'CV' : 'Job'} data saved securely to browser.`);
                } else {
                    UI.showMessage('Failed to save data. Storage may be full.', true);
                }
            }

            function resetForm(type) {
                if (!confirm(`Are you sure you want to clear all ${type === 'cv' ? 'CV' : 'Job'} data?`)) {
                    return;
                }

                StorageUtils.clear(type);
                const formId = type === 'cv' ? 'cvTemplateForm' : 'jobTemplateForm';
                const form = document.getElementById(formId);
                if (form) form.reset();

                ['certificationsContainer', 'languagesContainer', 'experienceContainer', 'educationContainer'].forEach(id => {
                    FormUtils.clearDynamicContainer(id);
                });

                UI.showMessage(`${type === 'cv' ? 'CV' : 'Job'} data cleared.`);

                const cvCleared = !StorageUtils.load('cv');
                const jobCleared = !StorageUtils.load('job');
                if (cvCleared && jobCleared) {
                    document.getElementById('cvTemplateSection').style.display = 'none';
                    document.getElementById('jobTemplateSection').style.display = 'none';
                    document.getElementById('uploadSection').style.display = 'block';
                }
            }

            // --- Event Listeners ---
            document.getElementById('cvFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const btn = document.getElementById('processBtn');
                if (btn) btn.disabled = !file;
            });

            document.getElementById('importFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    ProjectManager.handleImportFile(file);
                }
                this.value = ''; // Reset input
            });

            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', function() {
                const savedCv = StorageUtils.load('cv');
                const savedJob = StorageUtils.load('job');

                if (savedCv) {
                    FormSerializer.populate('cvTemplateForm', savedCv);
                    document.getElementById('cvTemplateSection').style.display = 'block';
                }
                if (savedJob) {
                    FormSerializer.populate('jobTemplateForm', savedJob);
                    document.getElementById('jobTemplateSection').style.display = 'block';
                }
                if (savedCv || savedJob) {
                    document.getElementById('uploadSection').style.display = 'none';
                    UI.showMessage('Loaded previously saved data from this browser.');
                }

                // Keyboard accessibility
                document.getElementById('cvFileInput').addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });

            // --- Expose functions to global scope ---
            window.handleCVProcess = handleCVProcess;
            window.saveFormData = saveFormData;
            window.resetForm = resetForm;
            window.addProject = () => DynamicFields.add('projectsContainer', 'project');
            window.exportProject = ProjectManager.exportProject;
            window.importProject = ProjectManager.importProject;

        })();
    </script>

</body>
</html>