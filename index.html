<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional CV Analyzer</title>
    <link rel="icon" href="data:,">
    <style>
        /* Professional Color Palette */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --secondary: #475569;
            --accent: #059669;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #dc2626;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--background);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Professional Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Professional Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header {
            background: var(--primary-light);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background: var(--surface);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Professional Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        /* Status Messages */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid transparent;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: var(--success);
            color: #065f46;
        }

        .alert-error {
            background: #fef2f2;
            border-color: var(--error);
            color: #991b1b;
        }

        /* Dynamic Items */
        .dynamic-container {
            margin-bottom: 1.5rem;
        }

        .dynamic-item {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .delete-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.25rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* File Input */
        .file-input {
            padding: 2rem;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            text-align: center;
            background: #f8fafc;
            margin-bottom: 1.5rem;
            transition: all 0.2s ease;
        }

        .file-input:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        /* Info Box */
        .info-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .card-body {
                padding: 1rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .dynamic-item {
                padding: 1rem;
            }
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* Grid Layout for Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìä Professional CV Analyzer</h1>
            <p>AI-powered CV analysis and job matching platform</p>
        </header>

        <div id="statusMessage" class="alert" style="display: none;" role="alert"></div>

        <!-- Upload Section -->
        <div id="uploadSection" class="card">
            <div class="card-header">
                <h2>üìÅ Upload CV Document</h2>
            </div>
            <div class="card-body">
                <div class="info-box">
                    <strong>Note:</strong> Upload your CV in PDF format (max 2MB). 
                    The AI will extract and structure your information for professional use.
                    Data is processed temporarily and stored only in your browser.
                </div>

                <div class="form-group">
                    <label class="form-label">Select PDF File:</label>
                    <input type="file" id="cvFileInput" class="form-control" accept=".pdf" />
                </div>

                <div class="action-buttons">
                    <button id="processBtn" class="btn btn-primary" disabled>
                        <span id="processText">ü§ñ Analyze CV with AI</span>
                        <span id="processSpinner" class="loading" style="display: none;"></span>
                    </button>
                    <button id="retryBtn" class="btn btn-secondary" style="display: none;">
                        üîÑ Re-analyze with AI
                    </button>
                </div>
            </div>
        </div>

        <!-- CV Template Section -->
        <div id="cvTemplateSection" class="card" style="display: none;">
            <div class="card-header">
                <h2>üë§ CV Information (Editable)</h2>
            </div>
            <div class="card-body">
                <form id="cvTemplateForm">
                    <h3 class="section-title">Personal Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="personalInfo.fullName">Full Name:</label>
                            <input type="text" class="form-control" name="personalInfo.fullName" id="personalInfo.fullName">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="personalInfo.professionalTitle">Professional Title:</label>
                            <input type="text" class="form-control" name="personalInfo.professionalTitle" id="personalInfo.professionalTitle">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="personalInfo.phone">Phone:</label>
                            <input type="text" class="form-control" name="personalInfo.phone" id="personalInfo.phone">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="personalInfo.email">Email:</label>
                            <input type="email" class="form-control" name="personalInfo.email" id="personalInfo.email">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="personalInfo.location">Location:</label>
                            <input type="text" class="form-control" name="personalInfo.location" id="personalInfo.location">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="personalInfo.linkedIn">LinkedIn:</label>
                            <input type="text" class="form-control" name="personalInfo.linkedIn" id="personalInfo.linkedIn">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="personalInfo.portfolio">Portfolio:</label>
                            <input type="text" class="form-control" name="personalInfo.portfolio" id="personalInfo.portfolio">
                        </div>
                    </div>

                    <h3 class="section-title">Professional Summary</h3>
                    <div class="form-group">
                        <textarea class="form-control" name="personalInfo.summary" id="personalInfo.summary" rows="4" 
                                  placeholder="AI-generated professional summary will appear here..."></textarea>
                    </div>

                    <h3 class="section-title">Core Competencies</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="coreCompetencies.technicalSkills">Technical Skills:</label>
                            <input type="text" class="form-control" name="coreCompetencies.technicalSkills" id="coreCompetencies.technicalSkills" 
                                   placeholder="Comma-separated list of technical skills">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="coreCompetencies.softSkills">Soft Skills:</label>
                            <input type="text" class="form-control" name="coreCompetencies.softSkills" id="coreCompetencies.softSkills" 
                                   placeholder="Comma-separated list of soft skills">
                        </div>
                    </div>

                    <h3 class="section-title">Certifications</h3>
                    <div id="certificationsContainer" class="dynamic-container"></div>
                    <button type="button" class="btn btn-outline" onclick="addCertification()">+ Add Certification</button>

                    <h3 class="section-title">Languages</h3>
                    <div id="languagesContainer" class="dynamic-container"></div>
                    <button type="button" class="btn btn-outline" onclick="addLanguage()">+ Add Language</button>

                    <h3 class="section-title">Professional Experience</h3>
                    <div id="experienceContainer" class="dynamic-container"></div>
                    <button type="button" class="btn btn-outline" onclick="addExperience()">+ Add Experience</button>

                    <h3 class="section-title">Education</h3>
                    <div id="educationContainer" class="dynamic-container"></div>
                    <button type="button" class="btn btn-outline" onclick="addEducation()">+ Add Education</button>

                    <h3 class="section-title">Projects</h3>
                    <div id="projectsContainer" class="dynamic-container"></div>
                    <button type="button" class="btn btn-outline" onclick="addProject()">+ Add Project</button>
                </form>

                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" onclick="saveFormData('cv')">üíæ Save CV Data</button>
                    <button type="button" class="btn btn-danger" onclick="resetForm('cv')">üóëÔ∏è Clear CV</button>
                    <button type="button" class="btn btn-secondary" onclick="exportProject()">üì§ Export Project</button>
                </div>
            </div>
        </div>

        <!-- Job Template Section -->
        <div id="jobTemplateSection" class="card" style="display: none;">
            <div class="card-header">
                <h2>üíº Job Matching Analysis</h2>
            </div>
            <div class="card-body">
                <form id="jobTemplateForm">
                    <h3 class="section-title">Job Targeting Strategy</h3>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label" for="jobIdentification.jobTitles">Recommended Job Titles:</label>
                            <textarea class="form-control" name="jobIdentification.jobTitles" id="jobIdentification.jobTitles" rows="3" 
                                      placeholder="Senior Frontend Developer, Full Stack Engineer, React Specialist..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="companyInformation.industrySector">Industry Sector:</label>
                            <input type="text" class="form-control" name="companyInformation.industrySector" id="companyInformation.industrySector" 
                                   placeholder="Technology, FinTech, E-commerce...">
                        </div>
                    </div>

                    <h3 class="section-title">Candidate Requirements</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="candidateRequirements.requiredEducationLevel">Required Education:</label>
                            <input type="text" class="form-control" name="candidateRequirements.requiredEducationLevel" id="candidateRequirements.requiredEducationLevel" 
                                   placeholder="Bachelor's Degree in Computer Science">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="candidateRequirements.requiredFieldOfStudy">Field of Study:</label>
                            <input type="text" class="form-control" name="candidateRequirements.requiredFieldOfStudy" id="candidateRequirements.requiredFieldOfStudy" 
                                   placeholder="Computer Science, Software Engineering">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="candidateRequirements.requiredYearsOfExperience">Years of Experience:</label>
                            <input type="text" class="form-control" name="candidateRequirements.requiredYearsOfExperience" id="candidateRequirements.requiredYearsOfExperience" 
                                   placeholder="3-5 years">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label" for="candidateRequirements.requiredSkills">Required Skills:</label>
                            <textarea class="form-control" name="candidateRequirements.requiredSkills" id="candidateRequirements.requiredSkills" rows="3" 
                                      placeholder="JavaScript, React, Node.js, AWS..."></textarea>
                        </div>
                    </div>
                </form>

                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" onclick="saveFormData('job')">üíæ Save Job Data</button>
                    <button type="button" class="btn btn-danger" onclick="resetForm('job')">üóëÔ∏è Clear Job</button>
                    <button type="button" class="btn btn-secondary" onclick="importProject()">üì• Import Project</button>
                </div>
            </div>
        </div>

        <input type="file" id="importFileInput" style="display: none;" accept=".json" />
    </div>

    <script>
// --- Application Configuration ---
const CONFIG = {
    BACKEND_API_ENDPOINT: '/api/processCV',
    MAX_FILE_SIZE_MB: 2,
    STORAGE_KEYS: { cv: 'cvData', job: 'jobData' }
};

// --- Security Utilities ---
const SecurityUtils = {
    sanitizeForDOM: (str) => {
        if (typeof str !== 'string') return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;');
    },
    
    validateFile: (file) => {
        if (!file) throw new Error('No file selected');
        if (file.type !== 'application/pdf') {
            throw new Error('Invalid file type. Only PDF files are supported.');
        }
        const maxSize = CONFIG.MAX_FILE_SIZE_MB * 1024 * 1024;
        if (file.size > maxSize) {
            throw new Error(`File too large. Maximum size is ${CONFIG.MAX_FILE_SIZE_MB}MB.`);
        }
    }
};

// --- Storage Utilities ---
const StorageUtils = {
    save: (key, data) => {
        try {
            localStorage.setItem(CONFIG.STORAGE_KEYS[key], JSON.stringify(data));
            return true;
        } catch (e) {
            console.error('Storage save failed:', e);
            return false;
        }
    },
    
    load: (key) => {
        try {
            const data = localStorage.getItem(CONFIG.STORAGE_KEYS[key]);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error('Storage load failed:', e);
            return null;
        }
    },
    
    clear: (key) => {
        localStorage.removeItem(CONFIG.STORAGE_KEYS[key]);
    }
};

// --- UI Management ---
const UI = {
    showMessage: (message, isError = false) => {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = isError ? 'alert alert-error' : 'alert alert-success';
        statusDiv.style.display = 'block';
        
        if (!isError) {
            setTimeout(() => UI.hideMessage(), 5000);
        }
    },
    
    hideMessage: () => {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.style.display = 'none';
    },
    
    setProcessingState: (isProcessing) => {
        const btn = document.getElementById('processBtn');
        const text = document.getElementById('processText');
        const spinner = document.getElementById('processSpinner');
        
        if (isProcessing) {
            btn.disabled = true;
            text.textContent = 'Processing...';
            spinner.style.display = 'inline-block';
        } else {
            btn.disabled = false;
            text.textContent = 'ü§ñ Analyze CV with AI';
            spinner.style.display = 'none';
        }
    },
    
    showSection: (sectionId) => {
        document.getElementById(sectionId).style.display = 'block';
    },
    
    hideSection: (sectionId) => {
        document.getElementById(sectionId).style.display = 'none';
    }
};

// --- Dynamic Field Templates ---
const DynamicTemplates = {
    certification: (index) => `
        <div class="dynamic-item" data-type="certification">
            <button type="button" class="delete-btn" onclick="this.parentElement.remove()">√ó</button>
            <div class="form-group">
                <label class="form-label">Certification Name:</label>
                <input type="text" class="form-control" name="certifications.${index}.name" placeholder="Certification Name" required>
            </div>
            <div class="form-group">
                <label class="form-label">Issuing Organization:</label>
                <input type="text" class="form-control" name="certifications.${index}.issuingOrganization" placeholder="Issuing Organization">
            </div>
            <div class="form-group">
                <label class="form-label">Date:</label>
                <input type="date" class="form-control" name="certifications.${index}.date">
            </div>
        </div>
    `,
    
    language: (index) => `
        <div class="dynamic-item" data-type="language">
            <button type="button" class="delete-btn" onclick="this.parentElement.remove()">√ó</button>
            <div class="form-group">
                <label class="form-label">Language:</label>
                <input type="text" class="form-control" name="languages.${index}.name" placeholder="Language Name" required>
            </div>
            <div class="form-group">
                <label class="form-label">Proficiency:</label>
                <input type="text" class="form-control" name="languages.${index}.proficiency" placeholder="Native/Fluent/Intermediate/Basic">
            </div>
        </div>
    `,
    
    experience: (index) => `
        <div class="dynamic-item" data-type="experience">
            <button type="button" class="delete-btn" onclick="this.parentElement.remove()">√ó</button>
            <h4>Experience ${index + 1}</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Job Title:</label>
                    <input type="text" class="form-control" name="experience.${index}.jobTitle" placeholder="Job Title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Company:</label>
                    <input type="text" class="form-control" name="experience.${index}.companyName" placeholder="Company Name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Employment Dates:</label>
                    <input type="text" class="form-control" name="experience.${index}.employmentDates" placeholder="Jan 2020 - Dec 2022">
                </div>
                <div class="form-group">
                    <label class="form-label">Location:</label>
                    <input type="text" class="form-control" name="experience.${index}.location" placeholder="City, Country">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Job Description:</label>
                    <textarea class="form-control" name="experience.${index}.jobDescription" rows="3" placeholder="Overall role description"></textarea>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Key Responsibilities:</label>
                    <textarea class="form-control" name="experience.${index}.keyResponsibilities" rows="2" placeholder="Key responsibilities"></textarea>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Key Achievements:</label>
                    <textarea class="form-control" name="experience.${index}.keyAchievements" rows="2" placeholder="Quantifiable achievements"></textarea>
                </div>
            </div>
        </div>
    `,
    
    education: (index) => `
        <div class="dynamic-item" data-type="education">
            <button type="button" class="delete-btn" onclick="this.parentElement.remove()">√ó</button>
            <h4>Education ${index + 1}</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Degree:</label>
                    <input type="text" class="form-control" name="education.${index}.degree" placeholder="Degree Name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Institution:</label>
                    <input type="text" class="form-control" name="education.${index}.institutionName" placeholder="Institution Name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Completion Date:</label>
                    <input type="text" class="form-control" name="education.${index}.completionDate" placeholder="2022">
                </div>
                <div class="form-group">
                    <label class="form-label">Location:</label>
                    <input type="text" class="form-control" name="education.${index}.location" placeholder="City, Country">
                </div>
            </div>
        </div>
    `,
    
    project: (index) => `
        <div class="dynamic-item" data-type="project">
            <button type="button" class="delete-btn" onclick="this.parentElement.remove()">√ó</button>
            <h4>Project ${index + 1}</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Project Title:</label>
                    <input type="text" class="form-control" name="projects.${index}.title" placeholder="Project Title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Technologies:</label>
                    <input type="text" class="form-control" name="projects.${index}.technologies" placeholder="Technologies Used">
                </div>
                <div class="form-group">
                    <label class="form-label">Dates:</label>
                    <input type="text" class="form-control" name="projects.${index}.dates" placeholder="Project Timeline">
                </div>
                <div class="form-group">
                    <label class="form-label">URL:</label>
                    <input type="text" class="form-control" name="projects.${index}.url" placeholder="Project URL">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Description:</label>
                    <textarea class="form-control" name="projects.${index}.description" rows="3" placeholder="Project description and outcomes"></textarea>
                </div>
            </div>
        </div>
    `
};

// --- Dynamic Field Management ---
const DynamicFields = {
    add: (containerId, type) => {
        const container = document.getElementById(containerId);
        const items = container.querySelectorAll(`[data-type="${type}"]`);
        const index = items.length;
        container.insertAdjacentHTML('beforeend', DynamicTemplates[type](index));
    },
    
    clear: (containerId) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
    }
};

// --- Form Serialization ---
const FormSerializer = {
    serialize: (form) => {
        const formData = new FormData(form);
        const result = {};
        
        for (const [key, value] of formData.entries()) {
            this.setNestedValue(result, key, value);
        }
        return result;
    },
    
    setNestedValue: (obj, path, value) => {
        const keys = path.split('.');
        let current = obj;
        
        for (let i = 0; i < keys.length - 1; i++) {
            const key = keys[i];
            const nextKey = keys[i + 1];
            const isArrayIndex = /^\d+$/.test(nextKey);
            
            if (!(key in current)) {
                current[key] = isArrayIndex ? [] : {};
            }
            current = current[key];
        }
        
        const lastKey = keys[keys.length - 1];
        if (Array.isArray(current)) {
            const index = parseInt(lastKey, 10);
            current[index] = value;
        } else {
            current[lastKey] = value;
        }
    },
    
    populate: (formId, data) => {
        const form = document.getElementById(formId);
        if (!form || !data) return;
        
        // Clear dynamic containers
        ['certificationsContainer', 'languagesContainer', 'experienceContainer', 'educationContainer', 'projectsContainer']
            .forEach(id => DynamicFields.clear(id));
        
        // Create minimum fields
        const fieldCounts = {
            certifications: Math.max(data.certifications?.length || 0, 1),
            languages: Math.max(data.languages?.length || 0, 1),
            experience: Math.max(data.experience?.length || 0, 1),
            education: Math.max(data.education?.length || 0, 1),
            projects: Math.max(data.projects?.length || 0, 1)
        };
        
        // Add fields
        for (let i = 0; i < fieldCounts.certifications; i++) DynamicFields.add('certificationsContainer', 'certification');
        for (let i = 0; i < fieldCounts.languages; i++) DynamicFields.add('languagesContainer', 'language');
        for (let i = 0; i < fieldCounts.experience; i++) DynamicFields.add('experienceContainer', 'experience');
        for (let i = 0; i < fieldCounts.education; i++) DynamicFields.add('educationContainer', 'education');
        for (let i = 0; i < fieldCounts.projects; i++) DynamicFields.add('projectsContainer', 'project');
        
        // Set values after a brief delay to ensure DOM is updated
        setTimeout(() => {
            const flattened = this.flattenObject(data);
            Object.entries(flattened).forEach(([key, value]) => {
                const element = form.querySelector(`[name="${key}"]`);
                if (element && value !== undefined && value !== null) {
                    element.value = SecurityUtils.sanitizeForDOM(String(value));
                }
            });
        }, 100);
    },
    
    flattenObject: (obj, prefix = '') => {
        const flattened = {};
        for (const [key, value] of Object.entries(obj)) {
            const newKey = prefix ? `${prefix}.${key}` : key;
            if (Array.isArray(value)) {
                value.forEach((item, index) => {
                    Object.assign(flattened, this.flattenObject(item, `${newKey}.${index}`));
                });
            } else if (typeof value === 'object' && value !== null) {
                Object.assign(flattened, this.flattenObject(value, newKey));
            } else {
                flattened[newKey] = value;
            }
        }
        return flattened;
    }
};

// --- File Processing ---
let lastProcessedFile = null;

async function handleCVProcess() {
    const fileInput = document.getElementById('cvFileInput');
    const file = fileInput.files[0];
    lastProcessedFile = file;
    
    try {
        SecurityUtils.validateFile(file);
        UI.hideMessage();
        UI.setProcessingState(true);
        
        const arrayBuffer = await file.arrayBuffer();
        const base64String = arrayBufferToBase64(arrayBuffer);
        
        const response = await fetch(CONFIG.BACKEND_API_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ pdfBase64: base64String })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `Server error: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Populate forms with AI data
        FormSerializer.populate('cvTemplateForm', result.cvData || {});
        FormSerializer.populate('jobTemplateForm', result.jobData || {});
        
        // Show results sections
        UI.showSection('cvTemplateSection');
        UI.showSection('jobTemplateSection');
        UI.hideSection('uploadSection');
        
        // Show retry button
        document.getElementById('retryBtn').style.display = 'inline-block';
        
        UI.showMessage('CV analyzed successfully! Please review and edit the information.');
        
    } catch (error) {
        console.error('Processing error:', error);
        UI.showMessage(`Error: ${error.message}`, true);
    } finally {
        UI.setProcessingState(false);
    }
}

async function handleRetryAnalysis() {
    if (!lastProcessedFile) {
        UI.showMessage('No previous CV to re-analyze.', true);
        return;
    }
    await handleCVProcess();
}

function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
}

// --- Data Management ---
function saveFormData(type) {
    const formId = type === 'cv' ? 'cvTemplateForm' : 'jobTemplateForm';
    const form = document.getElementById(formId);
    const data = FormSerializer.serialize(form);
    
    if (StorageUtils.save(type, data)) {
        UI.showMessage(`${type === 'cv' ? 'CV' : 'Job'} data saved successfully.`);
    } else {
        UI.showMessage('Failed to save data. Storage may be full.', true);
    }
}

function resetForm(type) {
    if (!confirm(`Are you sure you want to clear all ${type} data?`)) return;
    
    StorageUtils.clear(type);
    const formId = type === 'cv' ? 'cvTemplateForm' : 'jobTemplateForm';
    const form = document.getElementById(formId);
    if (form) form.reset();
    
    // Clear dynamic fields
    ['certificationsContainer', 'languagesContainer', 'experienceContainer', 'educationContainer', 'projectsContainer']
        .forEach(id => DynamicFields.clear(id));
    
    UI.showMessage(`${type === 'cv' ? 'CV' : 'Job'} data cleared.`);
    
    // If both forms are empty, show upload section
    if (!StorageUtils.load('cv') && !StorageUtils.load('job')) {
        UI.showSection('uploadSection');
        UI.hideSection('cvTemplateSection');
        UI.hideSection('jobTemplateSection');
    }
}

// --- Project Import/Export ---
function exportProject() {
    try {
        const cvData = FormSerializer.serialize(document.getElementById('cvTemplateForm'));
        const jobData = FormSerializer.serialize(document.getElementById('jobTemplateForm'));
        
        const projectData = {
            cvData,
            jobData,
            metadata: {
                exportDate: new Date().toISOString(),
                version: '1.0'
            }
        };
        
        const dataStr = JSON.stringify(projectData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `CV_Project_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        UI.showMessage('Project exported successfully!');
    } catch (error) {
        console.error('Export error:', error);
        UI.showMessage('Failed to export project.', true);
    }
}

function importProject() {
    document.getElementById('importFileInput').click();
}

function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const projectData = JSON.parse(e.target.result);
            
            if (!projectData.cvData || !projectData.jobData) {
                throw new Error('Invalid project file');
            }
            
            if (confirm('This will replace current data. Continue?')) {
                FormSerializer.populate('cvTemplateForm', projectData.cvData);
                FormSerializer.populate('jobTemplateForm', projectData.jobData);
                
                UI.showSection('cvTemplateSection');
                UI.showSection('jobTemplateSection');
                UI.hideSection('uploadSection');
                
                UI.showMessage('Project imported successfully!');
            }
        } catch (error) {
            console.error('Import error:', error);
            UI.showMessage('Invalid project file format.', true);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// --- Dynamic Field Functions (Global) ---
window.addCertification = () => DynamicFields.add('certificationsContainer', 'certification');
window.addLanguage = () => DynamicFields.add('languagesContainer', 'language');
window.addExperience = () => DynamicFields.add('experienceContainer', 'experience');
window.addEducation = () => DynamicFields.add('educationContainer', 'education');
window.addProject = () => DynamicFields.add('projectsContainer', 'project');
window.saveFormData = saveFormData;
window.resetForm = resetForm;
window.exportProject = exportProject;
window.importProject = importProject;

// --- Initialization ---
document.addEventListener('DOMContentLoaded', function() {
    // File input change handler
    document.getElementById('cvFileInput').addEventListener('change', function() {
        document.getElementById('processBtn').disabled = !this.files[0];
    });
    
    // Process button handler
    document.getElementById('processBtn').addEventListener('click', handleCVProcess);
    
    // Retry button handler
    document.getElementById('retryBtn').addEventListener('click', handleRetryAnalysis);
    
    // Import file handler
    document.getElementById('importFileInput').addEventListener('change', handleImportFile);
    
    // Load saved data
    const savedCv = StorageUtils.load('cv');
    const savedJob = StorageUtils.load('job');
    
    if (savedCv || savedJob) {
        if (savedCv) FormSerializer.populate('cvTemplateForm', savedCv);
        if (savedJob) FormSerializer.populate('jobTemplateForm', savedJob);
        
        UI.showSection('cvTemplateSection');
        UI.showSection('jobTemplateSection');
        UI.hideSection('uploadSection');
        
        UI.showMessage('Loaded previously saved data.');
    }
    
    console.log('Professional CV Analyzer initialized');
});
        // Complete JavaScript implementation will follow in the next message
        // This ensures the HTML structure is properly separated
        console.log('Professional CV Analyzer loaded');
    </script>
</body>
</html>