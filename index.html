<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CV Analyzer</title>
    <style>
    :root {
        /* Modern Creative Color Palette */
        --primary: #6366f1;      /* Vibrant indigo */
        --primary-dark: #4f46e5; /* Deep indigo */
        --secondary: #ec4899;    /* Electric pink */
        --accent: #8b5cf6;       /* Purple */
        --success: #10b981;      /* Emerald */
        --warning: #f59e0b;      /* Amber */
        --error: #ef4444;        /* Red */
        --background: #f8fafc;   /* Light background */
        --surface: #ffffff;      /* Card background */
        --text-primary: #1e293b; /* Dark text */
        --text-secondary: #64748b; /* Medium text */
        --text-muted: #94a3b8;   /* Light text */
        --border: #e2e8f0;       /* Border color */
        --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        --gradient-secondary: linear-gradient(135deg, #ec4899 0%, #f59e0b 100%);
    }

    * { 
        box-sizing: border-box; 
        margin: 0;
        padding: 0;
    }

    body { 
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
        margin: 0;
        padding: 20px;
        background: var(--background);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    h1 {
        font-size: 2.5rem;
        font-weight: 800;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-align: center;
        margin-bottom: 2rem;
        letter-spacing: -0.025em;
    }

    h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 3px solid;
        border-image: var(--gradient-primary) 1;
        display: inline-block;
    }

    h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 1.5rem 0 1rem 0;
        position: relative;
        padding-left: 1rem;
    }

    h3::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 20px;
        background: var(--gradient-secondary);
        border-radius: 2px;
    }

    /* Modern Card Design */
    .upload-section, .template-section { 
        margin-bottom: 2rem;
        padding: 2rem;
        background: var(--surface);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        transition: all 0.3s ease;
    }

    .upload-section:hover, .template-section:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    /* Modern Form Design */
    .form-group { 
        margin-bottom: 1.25rem;
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 1rem;
    }

    label { 
        display: block;
        min-width: 180px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        flex: 0 0 180px;
        font-size: 0.95rem;
    }

    input, textarea, select { 
        flex: 1 1 300px;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: var(--surface);
        color: var(--text-primary);
        min-width: 250px;
    }

    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        transform: translateY(-1px);
    }

    /* Modern Button Design */
    button { 
        padding: 0.75rem 1.5rem;
        margin: 0.25rem;
        cursor: pointer;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    button:active {
        transform: translateY(0);
    }

    button:disabled { 
        background: var(--text-muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-danger { 
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .btn-secondary { 
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    }

    /* Status Messages */
    #statusMessage { 
        margin: 1.5rem 0;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        display: none;
        font-weight: 500;
        box-shadow: var(--shadow);
    }

    .error { 
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        color: var(--error);
        border-left: 4px solid var(--error);
    }

    .success { 
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        color: var(--success);
        border-left: 4px solid var(--success);
    }

    /* Action Buttons Container */
    .action-buttons { 
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid var(--border);
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    /* Modern Dynamic Items */
    .dynamic-item { 
        border-left: 4px solid var(--accent);
        padding: 1.5rem;
        margin-bottom: 1rem;
        position: relative;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
    }

    .dynamic-item:hover {
        transform: translateX(4px);
        box-shadow: var(--shadow-lg);
    }

    .delete-btn { 
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        background: var(--gradient-secondary);
    }

    .dynamic-container { 
        margin-bottom: 1.5rem;
    }

    .add-btn { 
        margin: 1rem 0;
        background: var(--gradient-secondary);
    }

    /* File Input Styling */
    #cvFileInput {
        padding: 0.5rem;
        border: 2px dashed var(--border);
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        transition: all 0.3s ease;
    }

    #cvFileInput:hover {
        border-color: var(--primary);
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }

    /* Professional Summary Special Styling */
    #personalInfo\\.summary {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #bae6fd;
        font-style: italic;
        line-height: 1.8;
    }

    /* Job Titles Special Styling */
    #jobIdentification\\.jobTitles {
        background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
        border: 2px solid #e9d5ff;
        font-weight: 600;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        body {
            padding: 1rem;
        }

        .upload-section, .template-section {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        label { 
            flex: 0 0 100%;
            min-width: 100%;
        }

        input, textarea, select { 
            flex: 0 0 100%;
            min-width: 100%;
        }

        .form-group {
            gap: 0.5rem;
        }

        h1 {
            font-size: 2rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        button {
            width: 100%;
            margin: 0.25rem 0;
        }
    }

    @media (max-width: 480px) {
        h1 {
            font-size: 1.75rem;
        }

        .upload-section, .template-section {
            padding: 1rem;
        }

        .dynamic-item {
            padding: 1rem;
        }
    }

    /* Animation for success states */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .upload-section, .template-section {
        animation: fadeInUp 0.6s ease-out;
    }

    /* Loading state for buttons */
    button:disabled::after {
        content: '...';
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
</style>
</head>
<body>

    <h1>AI CV Analyzer</h1>
    <div id="statusMessage" role="alert"></div>

    <div id="uploadSection" class="upload-section">
        <h2>Upload Your CV</h2>
        <p style="color: #6b7280; font-size: 14px;">
            <strong>Privacy Notice:</strong> Your CV data is processed temporarily and stored only in this browser. 
            Always review AI-generated content for accuracy. Max file size: 2MB.
        </p>
        <input type="file" id="cvFileInput" accept=".pdf" aria-label="CV PDF file input" />
        <button id="processBtn" disabled>Analyze CV with AI</button>
        <button id="retryBtn" style="display: none;" class="btn-secondary">Re-analyze with AI</button>
    </div>

    <div id="cvTemplateSection" class="template-section" style="display: none;">
        <h2>CV Template (Editable)</h2>
        <form id="cvTemplateForm">
            <h3>Personal Information</h3>
            <div class="form-group">
                <label for="personalInfo.fullName">Full Name:</label>
                <input type="text" name="personalInfo.fullName" id="personalInfo.fullName">
            </div>
            <div class="form-group">
                <label for="personalInfo.professionalTitle">Professional Title:</label>
                <input type="text" name="personalInfo.professionalTitle" id="personalInfo.professionalTitle">
            </div>
            <div class="form-group">
                <label for="personalInfo.phone">Phone:</label>
                <input type="text" name="personalInfo.phone" id="personalInfo.phone">
            </div>
            <div class="form-group">
                <label for="personalInfo.email">Email:</label>
                <input type="email" name="personalInfo.email" id="personalInfo.email">
            </div>
            <div class="form-group">
                <label for="personalInfo.location">Location:</label>
                <input type="text" name="personalInfo.location" id="personalInfo.location">
            </div>
            <div class="form-group">
                <label for="personalInfo.linkedIn">LinkedIn:</label>
                <input type="text" name="personalInfo.linkedIn" id="personalInfo.linkedIn">
            </div>
            <div class="form-group">
                <label for="personalInfo.portfolio">Portfolio:</label>
                <input type="text" name="personalInfo.portfolio" id="personalInfo.portfolio">
            </div>

            <h3>Professional Summary</h3>
            <div class="form-group">
                <label for="personalInfo.summary">AI-Generated Summary:</label>
                <textarea name="personalInfo.summary" id="personalInfo.summary" rows="4" placeholder="AI will generate a professional summary from your CV"></textarea>
            </div>

            <h3>Core Competencies</h3>
            <div class="form-group">
                <label for="coreCompetencies.technicalSkills">Technical Skills:</label>
                <input type="text" name="coreCompetencies.technicalSkills" id="coreCompetencies.technicalSkills" placeholder="Comma-separated list">
            </div>
            <div class="form-group">
                <label for="coreCompetencies.softSkills">Soft Skills:</label>
                <input type="text" name="coreCompetencies.softSkills" id="coreCompetencies.softSkills" placeholder="Comma-separated list">
            </div>

            <h3>Certifications</h3>
            <div id="certificationsContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" >+ Add Certification</button>

            <h3>Languages</h3>
            <div id="languagesContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" >+ Add Language</button>

            <h3>Professional Experience</h3>
            <div id="experienceContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" >+ Add Experience</button>

            <h3>Education</h3>
            <div id="educationContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" >+ Add Education</button>

            <h3>Projects</h3>
            <div id="projectsContainer" class="dynamic-container"></div>
            <button type="button" class="btn-secondary add-btn" >+ Add Project</button>

            <h3>Additional Information</h3>
            <div class="form-group">
                <label for="additionalInfo.publications">Publications:</label>
                <textarea name="additionalInfo.publications" id="additionalInfo.publications" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="additionalInfo.professionalMemberships">Professional Memberships:</label>
                <textarea name="additionalInfo.professionalMemberships" id="additionalInfo.professionalMemberships" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="additionalInfo.volunteerExperience">Volunteer Experience:</label>
                <textarea name="additionalInfo.volunteerExperience" id="additionalInfo.volunteerExperience" rows="3"></textarea>
            </div>
        </form>
        <div class="action-buttons">
            <button type="button" >Save CV Data</button>
            <button type="button" class="btn-danger" >Clear CV</button>
            <button type="button" >Export Project as JSON</button>
        </div>
    </div>

    <div id="jobTemplateSection" class="template-section" style="display: none;">
        <h2>AI-Generated Job Questionnaire (Editable)</h2>
        <form id="jobTemplateForm">
            <h3>Job Targeting Strategy</h3>
            <div class="form-group">
                <label for="jobIdentification.jobTitles">Recommended Job Titles:</label>
                <textarea name="jobIdentification.jobTitles" id="jobIdentification.jobTitles" rows="3" placeholder="Senior Frontend Developer, Full Stack Engineer, React Specialist..."></textarea>
            </div>

            <div class="form-group">
                <label for="companyInformation.industrySector">Industry Sector:</label>
                <input type="text" name="companyInformation.industrySector" id="companyInformation.industrySector" placeholder="Technology, FinTech, E-commerce...">
            </div>

            <h3>Candidate Requirements</h3>
            <div class="form-group">
                <label for="candidateRequirements.requiredEducationLevel">Required Education:</label>
                <input type="text" name="candidateRequirements.requiredEducationLevel" id="candidateRequirements.requiredEducationLevel" placeholder="Bachelor's Degree in Computer Science">
            </div>
            <div class="form-group">
                <label for="candidateRequirements.requiredFieldOfStudy">Field of Study:</label>
                <input type="text" name="candidateRequirements.requiredFieldOfStudy" id="candidateRequirements.requiredFieldOfStudy" placeholder="Computer Science, Software Engineering">
            </div>
            <div class="form-group">
                <label for="candidateRequirements.requiredYearsOfExperience">Years of Experience:</label>
                <input type="text" name="candidateRequirements.requiredYearsOfExperience" id="candidateRequirements.requiredYearsOfExperience" placeholder="3-5 years">
            </div>
            <div class="form-group">
                <label for="candidateRequirements.requiredSkills">Required Skills:</label>
                <textarea name="candidateRequirements.requiredSkills" id="candidateRequirements.requiredSkills" rows="3" placeholder="JavaScript, React, Node.js, AWS..."></textarea>
            </div>

            <div class="form-group">
                <label for="jobIdentification.referenceID">Reference ID:</label>
                <input type="text" name="jobIdentification.referenceID" id="jobIdentification.referenceID">
            </div>
            <div class="form-group">
                <label for="jobIdentification.department">Department:</label>
                <input type="text" name="jobIdentification.department" id="jobIdentification.department">
            </div>
            <div class="form-group">
                <label for="jobIdentification.positionType">Position Type:</label>
                <select name="jobIdentification.positionType" id="jobIdentification.positionType">
                    <option value="">Select Type</option>
                    <option value="Full-time">Full-time</option>
                    <option value="Part-time">Part-time</option>
                    <option value="Contract">Contract</option>
                    <option value="Remote">Remote</option>
                </select>
            </div>

            <h3>Company Information</h3>
            <div class="form-group">
                <label for="companyInformation.companyName">Company Name:</label>
                <input type="text" name="companyInformation.companyName" id="companyInformation.companyName">
            </div>
            <div class="form-group">
                <label for="companyInformation.companySize">Company Size:</label>
                <input type="text" name="companyInformation.companySize" id="companyInformation.companySize">
            </div>

            <h3>Position Details</h3>
            <div class="form-group">
                <label for="positionDetails.jobDescription">Job Description:</label>
                <textarea name="positionDetails.jobDescription" id="positionDetails.jobDescription" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="positionDetails.keyResponsibilities">Key Responsibilities:</label>
                <textarea name="positionDetails.keyResponsibilities" id="positionDetails.keyResponsibilities" rows="4"></textarea>
            </div>

            <h3>Compensation & Benefits</h3>
            <div class="form-group">
                <label for="compensationBenefits.salaryRange">Salary Range:</label>
                <input type="text" name="compensationBenefits.salaryRange" id="compensationBenefits.salaryRange">
            </div>
            <div class="form-group">
                <label for="compensationBenefits.bonusStructure">Bonus Structure:</label>
                <input type="text" name="compensationBenefits.bonusStructure" id="compensationBenefits.bonusStructure">
            </div>
            <div class="form-group">
                <label for="compensationBenefits.healthInsurance">Health Insurance:</label>
                <input type="text" name="compensationBenefits.healthInsurance" id="compensationBenefits.healthInsurance">
            </div>
        </form>
        <div class="action-buttons">
            <button type="button" >Save Job Data</button>
            <button type="button" class="btn-danger" >Clear Job</button>
            <button type="button" >Import Project from JSON</button>
        </div>
    </div>

    <input type="file" id="importFileInput" style="display: none;" accept=".json" />

    <script>
        // --- IIFE to prevent global scope pollution ---
        (function() {
            'use strict';

            // --- Configuration ---
            const CONFIG = {
                BACKEND_API_ENDPOINT: '/api/processCV',
                MAX_FILE_SIZE_MB: 2,
                SUPPORTED_MIME_TYPES: ['application/pdf'],
                STORAGE_VERSION: 'v1.0',
                STORAGE_KEYS: { cv: 'cvData', job: 'jobData' }
            };

            // --- Sanitization & Validation Utilities ---
            const SecurityUtils = {
    sanitizeForDOM: (str) => {
        if (typeof str !== 'string') return '';
        // Proper HTML escaping
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;')
            .replace(/\//g, '&#x2F;');
    },
                sanitizeErrorMessage: (msg) => {
                    if (typeof msg !== 'string') return 'An unknown error occurred';
                    return msg.replace(/\(.*?\)|\[.*?\]/g, '').substring(0, 200);
                },
                validateFile: (file) => {
                    if (!file) throw new Error('No file selected');
                    if (!CONFIG.SUPPORTED_MIME_TYPES.includes(file.type)) {
                        throw new Error(`Invalid file type. Only PDFs are supported.`);
                    }
                    const maxSize = CONFIG.MAX_FILE_SIZE_MB * 1024 * 1024;
                    if (file.size > maxSize) {
                        throw new Error(`File too large. Maximum size is ${CONFIG.MAX_FILE_SIZE_MB}MB.`);
                    }
                }
            };

            // --- Data Persistence Utilities ---
            const StorageUtils = {
                save: (key, data) => {
                    try {
                        const payload = {
                            version: CONFIG.STORAGE_VERSION,
                            timestamp: new Date().toISOString(),
                            data: data
                        };
                        const obfuscated = btoa(JSON.stringify(payload));
                        localStorage.setItem(CONFIG.STORAGE_KEYS[key], obfuscated);
                        return true;
                    } catch (e) {
                        console.error('Storage save failed:', e);
                        return false;
                    }
                },
                load: (key) => {
                    try {
                        const obfuscated = localStorage.getItem(CONFIG.STORAGE_KEYS[key]);
                        if (!obfuscated) return null;
                        const payload = JSON.parse(atob(obfuscated));
                        if (payload.version !== CONFIG.STORAGE_VERSION) {
                            console.warn('Data version mismatch. Ignoring old data.');
                            return null;
                        }
                        return payload.data || null;
                    } catch (e) {
                        console.error('Storage load failed:', e);
                        return null;
                    }
                },
                clear: (key) => {
                    localStorage.removeItem(CONFIG.STORAGE_KEYS[key]);
                }
            };

            // --- DOM & Form Utilities ---
            const FormUtils = {
                clearDynamicContainer: (containerId) => {
                    const container = document.getElementById(containerId);
                    if (!container) {
                        console.error(`Container not found: ${containerId}`);
                        return;
                    }
                    container.innerHTML = '';
                },
                createDeleteButton: (onclickHandler, type, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = 'Delete';
                    btn.className = 'delete-btn btn-danger';
                    btn.onclick = onclickHandler;
                    btn.setAttribute('aria-label', `Delete ${type} ${index + 1}`);
                    return btn;
                },
                disableButton: (btnId, disabled) => {
                    const btn = document.getElementById(btnId);
                    if (btn) btn.disabled = disabled;
                }
            };

            // --- Dynamic Field Management ---
            const DynamicFields = {
                templates: {
                    certification: (index) => `
                        <div class="dynamic-item" data-type="certification">
                            <input type="text" name="certifications.${index}.name" placeholder="Certification Name" required>
                            <input type="text" name="certifications.${index}.issuingOrganization" placeholder="Issuing Organization">
                            <input type="date" name="certifications.${index}.date" placeholder="Date (YYYY-MM-DD)">
                        </div>`,
                    language: (index) => `
                        <div class="dynamic-item" data-type="language">
                            <input type="text" name="languages.${index}.name" placeholder="Language Name" required>
                            <input type="text" name="languages.${index}.proficiency" placeholder="Proficiency (e.g., Native, Fluent)">
                        </div>`,
                    experience: (index) => `
                        <div class="dynamic-item" data-type="experience">
                            <h4>Experience ${index + 1}</h4>
                            <input type="text" name="experience.${index}.jobTitle" placeholder="Job Title" required>
                            <input type="text" name="experience.${index}.companyName" placeholder="Company Name" required>
                            <input type="text" name="experience.${index}.employmentDates" placeholder="e.g., Jan 2020 - Dec 2022">
                            <input type="text" name="experience.${index}.location" placeholder="Location">
                            <textarea name="experience.${index}.jobDescription" rows="3" placeholder="Job Description (paragraph format)"></textarea>
                            <textarea name="experience.${index}.keyResponsibilities" rows="2" placeholder="Key Responsibilities (bullet points)"></textarea>
                            <textarea name="experience.${index}.keyAchievements" rows="2" placeholder="Key Achievements (quantified results)"></textarea>
                        </div>`,
                    education: (index) => `
                        <div class="dynamic-item" data-type="education">
                            <h4>Education ${index + 1}</h4>
                            <input type="text" name="education.${index}.degree" placeholder="Degree/Qualification" required>
                            <input type="text" name="education.${index}.institutionName" placeholder="Institution Name" required>
                            <input type="text" name="education.${index}.completionDate" placeholder="e.g., 2022">
                            <input type="text" name="education.${index}.location" placeholder="Location">
                        </div>`,
                    project: (index) => `
                        <div class="dynamic-item" data-type="project">
                            <h4>Project ${index + 1}</h4>
                            <input type="text" name="projects.${index}.title" placeholder="Project Title" required>
                            <input type="text" name="projects.${index}.description" placeholder="Project Description">
                            <input type="text" name="projects.${index}.technologies" placeholder="Technologies Used">
                            <input type="text" name="projects.${index}.dates" placeholder="Project Dates">
                            <input type="text" name="projects.${index}.url" placeholder="Project URL/Link">
                        </div>`
                },
                add: (containerId, type) => {
                    const container = document.getElementById(containerId);
                    if (!container) {
                        console.error(`Container not found: ${containerId}`);
                        return;
                    }
                    const existingItems = container.querySelectorAll(`[data-type="${type}"]`);
                    const index = existingItems.length;
                    container.insertAdjacentHTML('beforeend', DynamicFields.templates[type](index));
                    const newItem = container.lastElementChild;
                    const deleteBtn = FormUtils.createDeleteButton(() => newItem.remove(), type, index);
                    newItem.appendChild(deleteBtn);
                }
            };

            // --- Form Population & Serialization ---
            const FormSerializer = {
                populate: (formId, data) => {
                    const form = document.getElementById(formId);
                    if (!data || !form) return;

                    // Clear existing dynamic fields
                    ['certificationsContainer', 'languagesContainer', 'experienceContainer', 'educationContainer', 'projectsContainer'].forEach(id => {
                        FormUtils.clearDynamicContainer(id);
                    });

                    // PRE-CREATE 3 DEFAULT FIELDS + AI-DETECTED FIELDS
                    const fieldCreation = {
                        certifications: Math.max(data.certifications?.length || 0, 3),
                        languages: Math.max(data.languages?.length || 0, 3),
                        experience: Math.max(data.experience?.length || 0, 3),
                        education: Math.max(data.education?.length || 0, 3),
                        projects: Math.max(data.projects?.length || 0, 3)
                    };

                    // Create fields (minimum 3 of each type)
                    for (let i = 0; i < fieldCreation.certifications; i++) DynamicFields.add('certificationsContainer', 'certification');
                    for (let i = 0; i < fieldCreation.languages; i++) DynamicFields.add('languagesContainer', 'language');
                    for (let i = 0; i < fieldCreation.experience; i++) DynamicFields.add('experienceContainer', 'experience');
                    for (let i = 0; i < fieldCreation.education; i++) DynamicFields.add('educationContainer', 'education');
                    for (let i = 0; i < fieldCreation.projects; i++) DynamicFields.add('projectsContainer', 'project');

                    // Set values after DOM is populated
                    setTimeout(() => {
                        const flattened = FormSerializer.flattenObject(data);
                        Object.entries(flattened).forEach(([key, value]) => {
                            const element = form.querySelector(`[name="${key}"]`);
                            if (element && value !== undefined && value !== null && value !== '') {
                                element.value = SecurityUtils.sanitizeForDOM(value);
                            }
                        });
                    }, 100);
                },

                flattenObject: (obj, prefix = '') => {
                    const flattened = {};
                    for (const [key, value] of Object.entries(obj)) {
                        const newKey = prefix ? `${prefix}.${key}` : key;
                        if (Array.isArray(value)) {
                            value.forEach((item, index) => {
                                Object.assign(flattened, FormSerializer.flattenObject(item, `${newKey}.${index}`));
                            });
                        } else if (typeof value === 'object' && value !== null) {
                            Object.assign(flattened, FormSerializer.flattenObject(value, newKey));
                        } else {
                            flattened[newKey] = value;
                        }
                    }
                    return flattened;
                },

                serialize: (form) => {
                    const formData = new FormData(form);
                    const result = {};

                    for (const [key, value] of formData.entries()) {
                        FormSerializer.setNestedValue(result, key, value);
                    }
                    return result;
                },

                setNestedValue: (obj, path, value) => {
                    const keys = path.split('.');
                    let current = obj;

                    for (let i = 0; i < keys.length - 1; i++) {
                        const key = keys[i];
                        const nextKey = keys[i + 1];
                        const isArrayIndex = /^\d+$/.test(nextKey);

                        if (!(key in current)) {
                            current[key] = isArrayIndex ? [] : {};
                        }
                        current = current[key];
                    }

                    const finalKey = keys[keys.length - 1];
                    if (Array.isArray(current)) {
                        const index = parseInt(finalKey, 10);
                        if (!isNaN(index)) {
                            current[index] = value;
                        } else {
                            current.push({ [finalKey]: value });
                        }
                    } else {
                        current[finalKey] = value;
                    }
                }
            };

            // --- UI State Management ---
            const UI = {
                showMessage: (message, isError = false) => {
                    const statusDiv = document.getElementById('statusMessage');
                    statusDiv.textContent = SecurityUtils.sanitizeForDOM(message);
                    statusDiv.className = isError ? 'error' : 'success';
                    statusDiv.style.display = 'block';
                    statusDiv.setAttribute('role', 'alert');

                    if (!isError) {
                        setTimeout(() => UI.hideMessage(), 5000);
                    }
                },
                hideMessage: () => {
                    const statusDiv = document.getElementById('statusMessage');
                    if (statusDiv) statusDiv.style.display = 'none';
                },
                setProcessingState: (isProcessing) => {
                    FormUtils.disableButton('processBtn', isProcessing);
                    const btn = document.getElementById('processBtn');
                    if (btn) {
                        btn.textContent = isProcessing ? 'Processing...' : 'Analyze CV with AI';
                    }
                }
            };

            // --- JSON Export/Import ---
            const ProjectManager = {
                exportProject: () => {
                    try {
                        const cvData = FormSerializer.serialize(document.getElementById('cvTemplateForm'));
                        const jobData = FormSerializer.serialize(document.getElementById('jobTemplateForm'));
                        
                        const projectData = {
                            cvData: cvData,
                            jobData: jobData,
                            metadata: {
                                exportDate: new Date().toISOString(),
                                version: CONFIG.STORAGE_VERSION,
                                projectName: 'CV_Analyzer_Project'
                            }
                        };

                        const dataStr = JSON.stringify(projectData, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `CV_Project_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        UI.showMessage('Project exported successfully!');
                    } catch (error) {
                        console.error('Export error:', error);
                        UI.showMessage('Failed to export project', true);
                    }
                },

                importProject: () => {
                    document.getElementById('importFileInput').click();
                },

                handleImportFile: (file) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const projectData = JSON.parse(e.target.result);
                            
                            // Validate structure
                            if (!projectData.cvData || !projectData.jobData) {
                                throw new Error('Invalid project file structure');
                            }

                            if (confirm('This will replace all current data. Continue?')) {
                                FormSerializer.populate('cvTemplateForm', projectData.cvData);
                                FormSerializer.populate('jobTemplateForm', projectData.jobData);
                                
                                document.getElementById('cvTemplateSection').style.display = 'block';
                                document.getElementById('jobTemplateSection').style.display = 'block';
                                document.getElementById('uploadSection').style.display = 'none';
                                
                                UI.showMessage('Project imported successfully!');
                            }
                        } catch (error) {
                            console.error('Import error:', error);
                            UI.showMessage('Invalid project file format', true);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            // --- Main Processing Logic ---
            // Store the last processed file for retry
            let lastProcessedFile = null;
            async function handleCVProcess() {
                const fileInput = document.getElementById('cvFileInput');
                const file = fileInput.files[0];
                lastProcessedFile = file; // Store for potential retry

                try {
                    SecurityUtils.validateFile(file);

                    const hasExistingData = StorageUtils.load('cv') || StorageUtils.load('job');
                    if (hasExistingData && !confirm('This will replace existing data. Continue?')) {
                        return;
                    }

                    UI.hideMessage();
                    UI.setProcessingState(true);
                    UI.showMessage('Processing CV... Please wait.');

                    const arrayBuffer = await file.arrayBuffer();
                    const base64String = arrayBufferToBase64(arrayBuffer);

                    const response = await fetch(CONFIG.BACKEND_API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ 
                            pdfBase64: base64String,
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Backend error: ${response.status}`);
                    }

                    const result = await response.json();

                    if (!result || typeof result !== 'object') {
                        throw new Error('Invalid response format from server');
                    }

                    // === COMPREHENSIVE QUALITY CHECK ===
                    function validateAIOutput(result) {
                        const summary = result.cvData?.personalInfo?.summary || '';
                        
                        const garbagePatterns = [
                            'is about at', 'is short at', 'Lantz', 'Lamis is short at',
                            'undefined', 'null', '[object Object]', '...', 'etc etc'
                        ];
                        
                        if (garbagePatterns.some(pattern => summary.includes(pattern))) {
                            throw new Error('AI generated low-quality content. Please try again.');
                        }
                        
                        if (summary.length < 50 || summary.split('. ').length < 2) {
                            throw new Error('Summary appears incomplete. Please try again.');
                        }
                        
                        return true;
                    }

                    validateAIOutput(result);

                    // === ONLY POPULATE IF QUALITY CHECK PASSES ===
                    FormSerializer.populate('cvTemplateForm', result.cvData || {});
                    FormSerializer.populate('jobTemplateForm', result.jobData || {});

                    document.getElementById('cvTemplateSection').style.display = 'block';
                    document.getElementById('jobTemplateSection').style.display = 'block';
                    document.getElementById('uploadSection').style.display = 'none';

                    UI.showMessage('CV analyzed successfully! Please review and edit the templates.');
                    toggleRetryButton(true);
                } catch (error) {
                    console.error('Processing error:', error);
                    UI.showMessage(`Error: ${SecurityUtils.sanitizeErrorMessage(error.message)}`, true);
                } finally {
                    UI.setProcessingState(false);
                }
            }

            function arrayBufferToBase64(buffer) {
            // New function for user-controlled retry
           async function handleRetryAnalysis() {
                if (!lastProcessedFile) {
                    UI.showMessage('No previous CV to re-analyze. Please upload a CV first.', true);
                    return;
                }
                try {
                    UI.hideMessage();
                    UI.setProcessingState(true);
                    UI.showMessage('Re-analyzing CV with AI...');

                    const arrayBuffer = await lastProcessedFile.arrayBuffer();
                    const base64String = arrayBufferToBase64(arrayBuffer);

                    const response = await fetch(CONFIG.BACKEND_API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ 
                            pdfBase64: base64String,
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Backend error: ${response.status}`);
                    }

                    const result = await response.json();

                    if (!result || typeof result !== 'object') {
                        throw new Error('Invalid response format from server');
                    }

                    // Repopulate forms with new AI results
                    FormSerializer.populate('cvTemplateForm', result.cvData || {});
                    FormSerializer.populate('jobTemplateForm', result.jobData || {});

                    UI.showMessage('CV re-analyzed successfully! Review the updated templates.');

                } catch (error) {
                    console.error('Retry error:', error);
                    UI.showMessage(`Error: ${SecurityUtils.sanitizeErrorMessage(error.message)}`, true);
                } finally {
                    UI.setProcessingState(false);
                }
            }
            }

            // Show/hide retry button based on state
            function toggleRetryButton(show) {
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) {
                    retryBtn.style.display = show ? 'inline-block' : 'none';
                    console.log('Retry button display set to:', retryBtn.style.display);
                } else {
                    console.error('Retry button not found in DOM!');
                }
            }
            // Show/hide retry button based on state
            function toggleRetryButton(show) {
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) {
                    retryBtn.style.display = show ? 'inline-block' : 'none';
                }
            }
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }

            // --- Save & Reset Functions ---
            function saveFormData(type) {
                const formId = type === 'cv' ? 'cvTemplateForm' : 'jobTemplateForm';
                const form = document.getElementById(formId);
                if (!form) return;

                const data = FormSerializer.serialize(form);

                if (StorageUtils.save(type, data)) {
                    UI.showMessage(`${type === 'cv' ? 'CV' : 'Job'} data saved securely to browser.`);
                } else {
                    UI.showMessage('Failed to save data. Storage may be full.', true);
                }
            }

            function resetForm(type) {
                if (!confirm(`Are you sure you want to clear all ${type === 'cv' ? 'CV' : 'Job'} data?`)) {
                    return;
                }

                StorageUtils.clear(type);
                const formId = type === 'cv' ? 'cvTemplateForm' : 'jobTemplateForm';
                const form = document.getElementById(formId);
                if (form) form.reset();

                ['certificationsContainer', 'languagesContainer', 'experienceContainer', 'educationContainer', 'projectsContainer'].forEach(id => {
                    FormUtils.clearDynamicContainer(id);
                });

                UI.showMessage(`${type === 'cv' ? 'CV' : 'Job'} data cleared.`);

                const cvCleared = !StorageUtils.load('cv');
                const jobCleared = !StorageUtils.load('job');
                if (cvCleared && jobCleared) {
                    document.getElementById('cvTemplateSection').style.display = 'none';
                    document.getElementById('jobTemplateSection').style.display = 'none';
                    document.getElementById('uploadSection').style.display = 'block';
                }
            }

            // --- Event Listeners ---
            document.getElementById('cvFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const btn = document.getElementById('processBtn');
                if (btn) btn.disabled = !file;
            });

            document.getElementById('importFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    ProjectManager.handleImportFile(file);
                }
                this.value = '';
            });

            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', function() {
                const savedCv = StorageUtils.load('cv');
                const savedJob = StorageUtils.load('job');

                if (savedCv) {
                    FormSerializer.populate('cvTemplateForm', savedCv);
                    document.getElementById('cvTemplateSection').style.display = 'block';
                }
                if (savedJob) {
                    FormSerializer.populate('jobTemplateForm', savedJob);
                    document.getElementById('jobTemplateSection').style.display = 'block';
                }
                if (savedCv || savedJob) {
                    document.getElementById('uploadSection').style.display = 'none';
                    UI.showMessage('Loaded previously saved data from this browser.');
                }

                            document.getElementById('cvFileInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });

            // === ADD EVENT LISTENER SETUP HERE ===
            document.getElementById('processBtn')?.addEventListener('click', handleCVProcess);
            document.getElementById('retryBtn')?.addEventListener('click', handleRetryAnalysis);
            
            // CV Template buttons
            const cvActionButtons = document.querySelector('#cvTemplateSection .action-buttons');
            if (cvActionButtons) {
                cvActionButtons.querySelector('button:nth-child(1)')?.addEventListener('click', () => saveFormData('cv'));
                cvActionButtons.querySelector('button:nth-child(2)')?.addEventListener('click', () => resetForm('cv'));
                cvActionButtons.querySelector('button:nth-child(3)')?.addEventListener('click', exportProject);
            }
            
            // Job Template buttons  
            const jobActionButtons = document.querySelector('#jobTemplateSection .action-buttons');
            if (jobActionButtons) {
                jobActionButtons.querySelector('button:nth-child(1)')?.addEventListener('click', () => saveFormData('job'));
                jobActionButtons.querySelector('button:nth-child(2)')?.addEventListener('click', () => resetForm('job'));
                jobActionButtons.querySelector('button:nth-child(3)')?.addEventListener('click', importProject);
            }
            
            // Dynamic field buttons
            document.querySelector('button[class*="add-btn"]:has(+ #certificationsContainer)')?.addEventListener('click', addCertification);
            document.querySelector('button[class*="add-btn"]:has(+ #languagesContainer)')?.addEventListener('click', addLanguage);
            document.querySelector('button[class*="add-btn"]:has(+ #experienceContainer)')?.addEventListener('click', addExperience);
            document.querySelector('button[class*="add-btn"]:has(+ #educationContainer)')?.addEventListener('click', addEducation);
            document.querySelector('button[class*="add-btn"]:has(+ #projectsContainer)')?.addEventListener('click', addProject);
        }); //  KEEP THIS CLOSING BRACE FOR DOMContentLoaded

        // --- Expose functions to global scope ---
        window.handleCVProcess = handleCVProcess;
        window.saveFormData = saveFormData;
        window.resetForm = resetForm;
        window.addCertification = () => DynamicFields.add('certificationsContainer', 'certification');
        window.addLanguage = () => DynamicFields.add('languagesContainer', 'language');
        window.addExperience = () => DynamicFields.add('experienceContainer', 'experience');
        window.addEducation = () => DynamicFields.add('educationContainer', 'education');
        window.addProject = () => DynamicFields.add('projectsContainer', 'project');
        window.exportProject = ProjectManager.exportProject;
        window.importProject = ProjectManager.importProject;

     
        })();
    </script>
</body>
</html>